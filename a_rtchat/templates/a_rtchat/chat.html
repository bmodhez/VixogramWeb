{% extends 'base.html' %}
{% load static %}

{% block html_class %}vixo-chat-page{% endblock %}
{% block body_class %}vixo-chat-page{% endblock %}

{% block content %}
<wrapper class="block w-full min-w-0 max-w-full overflow-x-hidden">
    <div class="flex flex-col lg:flex-row lg:items-stretch gap-4 lg:gap-6 min-w-0 max-w-full">

        <aside id="chat_sidebar" class="hidden lg:block w-full lg:w-72 shrink-0">
            <div id="chat_sidebar_panel" data-chat-list class="vixo-chat-surface w-full max-w-md lg:max-w-none lg:w-72 h-[calc(100dvh-6rem)] sm:h-[calc(100dvh-6.5rem)] min-h-0 bg-gray-800/70 border border-gray-800 rounded-2xl shadow-2xl p-4 overflow-y-auto">
                <div class="flex items-center justify-between gap-2 mb-3">
                    <div class="text-sm font-semibold text-gray-200">Chats</div>
                    <button type="button" id="chat_sidebar_close" class="lg:hidden inline-flex h-9 w-9 items-center justify-center rounded-lg text-gray-200 hover:bg-gray-800/60" aria-label="Close chats">√ó</button>
                </div>

            {% if user.is_staff %}
                <div class="mb-4">
                    <button
                        type="button"
                        class="w-full flex items-center justify-between gap-2 text-xs font-semibold text-gray-400 hover:text-gray-200 transition-colors"
                        data-vixo-collapse-toggle
                        data-vixo-collapse-key="admin-features"
                        aria-expanded="true"
                    >
                        <span class="truncate">Admin Features</span>
                        <svg class="w-3.5 h-3.5 shrink-0 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-vixo-collapse-chevron>
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 11.06l3.71-3.83a.75.75 0 1 1 1.08 1.04l-4.24 4.38a.75.75 0 0 1-1.08 0L5.21 8.27a.75.75 0 0 1 .02-1.06Z" clip-rule="evenodd" />
                        </svg>
                    </button>

                    <div class="mt-2 space-y-2" data-vixo-collapse-body data-vixo-collapse-key="admin-features">
                        <div class="px-3 py-2 rounded-lg bg-gray-900/30 border border-gray-800">
                            <div class="flex items-center justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="text-sm font-semibold text-gray-200 truncate">Put site under maintenance</div>
                                    <div class="text-xs text-gray-400 truncate">Blocks non-admin users in realtime</div>
                                </div>
                                <div class="flex items-center gap-2 shrink-0">
                                    <span id="vixo-maintenance-state" class="text-[11px] font-semibold text-gray-400">‚Ä¶</span>
                                    <label class="relative inline-flex items-center cursor-pointer select-none">
                                        <input id="vixo-maintenance-toggle" type="checkbox" class="sr-only peer" />
                                        <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:bg-emerald-600 transition-colors after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-transform peer-checked:after:translate-x-5"></div>
                                    </label>
                                </div>
                            </div>
                            <div id="vixo-maintenance-hint" class="mt-1 text-[11px] text-gray-500 hidden"></div>
                        </div>

                        <div class="space-y-1">
                            <a href="{% url 'admin-analytics' %}"
                                class="block px-3 py-2 rounded-lg text-sm hover:bg-gray-800/60 text-gray-300">
                                Analytics
                            </a>
                            <a href="{% url 'new-groupchat' %}"
                                class="block px-3 py-2 rounded-lg text-sm hover:bg-gray-800/60 text-gray-300">
                                Create group chat
                            </a>
                            <a href="{% url 'admin-users' %}"
                                class="block px-3 py-2 rounded-lg text-sm hover:bg-gray-800/60 text-gray-300">
                                Manage users
                            </a>
                            <a href="{% url 'admin-reports' %}"
                                class="flex items-center justify-between gap-2 px-3 py-2 rounded-lg text-sm hover:bg-gray-800/60 text-gray-300">
                                <span>User reports</span>
                                {% if ADMIN_OPEN_REPORTS|default:0 %}
                                    <span class="text-[11px] font-semibold bg-amber-500 text-white px-2 py-0.5 rounded-full">{{ ADMIN_OPEN_REPORTS }}</span>
                                {% endif %}
                            </a>
                            <a href="{% url 'admin-support-enquiries' %}"
                                class="flex items-center justify-between gap-2 px-3 py-2 rounded-lg text-sm hover:bg-gray-800/60 text-gray-300">
                                <span>Support enquiries</span>
                                {% if ADMIN_OPEN_SUPPORT_ENQUIRIES|default:0 %}
                                    <span class="text-[11px] font-semibold bg-amber-500 text-white px-2 py-0.5 rounded-full">{{ ADMIN_OPEN_SUPPORT_ENQUIRIES }}</span>
                                {% endif %}
                            </a>
                            <a href="{% url 'moderation-logs' %}"
                                class="block px-3 py-2 rounded-lg text-sm hover:bg-gray-800/60 text-gray-300">
                                Moderation logs
                            </a>
                        </div>
                    </div>
                </div>
            {% endif %}

            <div class="mb-4">
                <a data-chat-list-item href="{% url 'chatroom' 'public-chat' %}"
                         class="block pr-3 py-2 rounded-lg text-sm hover:bg-gray-800/60 transition-colors
                         {% if chat_group.group_name == 'public-chat' %}pl-2 border-l-4 border-indigo-500 bg-indigo-500/10 text-emerald-400 font-semibold{% else %}px-3 text-gray-300{% endif %}">
                    Public chat
                </a>
            </div>

            {% if sidebar_groupchats %}
                <div class="text-xs font-semibold text-gray-400 mb-2">Group chats</div>
                <div class="mb-4">
                    {% if sidebar_groupchat_sections %}
                        {% for section in sidebar_groupchat_sections %}
                            <div class="mt-3 mb-1">
                                <button
                                    type="button"
                                    class="w-full flex items-center justify-between gap-2 text-[11px] font-semibold text-gray-400 hover:text-gray-200 transition-colors"
                                    data-vixo-collapse-toggle
                                    data-vixo-collapse-key="group-section-{{ forloop.counter }}"
                                    aria-expanded="true"
                                >
                                    <span class="truncate">{{ section.title }}</span>
                                    <svg class="w-3.5 h-3.5 shrink-0 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-vixo-collapse-chevron>
                                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 11.06l3.71-3.83a.75.75 0 1 1 1.08 1.04l-4.24 4.38a.75.75 0 0 1-1.08 0L5.21 8.27a.75.75 0 0 1 .02-1.06Z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            <div data-vixo-collapse-body data-vixo-collapse-key="group-section-{{ forloop.counter }}">
                                {% if section.rooms %}
                                    <ul class="space-y-1">
                                        {% for room in section.rooms %}
                                            <li>
                                                <a data-chat-list-item href="{% url 'chatroom' room.group_name %}"
                                                              class="block pr-3 py-2 rounded-lg text-sm hover:bg-gray-800/60 transition-colors
                                                              {% if chat_group.group_name == room.group_name %}pl-2 border-l-4 border-indigo-500 bg-indigo-500/10 text-emerald-400 font-semibold{% else %}px-3 text-gray-300{% endif %}">
                                                    {{ room.groupchat_name|default:room.group_name|slice:":30" }}
                                                </a>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <div class="px-3 py-2 text-xs text-gray-500">No rooms yet</div>
                                {% endif %}
                            </div>
                        {% endfor %}

                        {% if sidebar_groupchats_remaining %}
                            <ul class="space-y-1 mt-3">
                                {% for room in sidebar_groupchats_remaining %}
                                    <li>
                                        <a data-chat-list-item href="{% url 'chatroom' room.group_name %}"
                                             class="block pr-3 py-2 rounded-lg text-sm hover:bg-gray-800/60 transition-colors
                                             {% if chat_group.group_name == room.group_name %}pl-2 border-l-4 border-indigo-500 bg-indigo-500/10 text-emerald-400 font-semibold{% else %}px-3 text-gray-300{% endif %}">
                                            {{ room.groupchat_name|default:room.group_name|slice:":30" }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% else %}
                        <ul class="space-y-1">
                            {% for room in sidebar_groupchats %}
                                <li>
                                    <a data-chat-list-item href="{% url 'chatroom' room.group_name %}"
                                                    class="block pr-3 py-2 rounded-lg text-sm hover:bg-gray-800/60 transition-colors
                                                    {% if chat_group.group_name == room.group_name %}pl-2 border-l-4 border-indigo-500 bg-indigo-500/10 text-emerald-400 font-semibold{% else %}px-3 text-gray-300{% endif %}">
                                        {{ room.groupchat_name|default:room.group_name|slice:":30" }}
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            {% endif %}

            <div class="text-xs font-semibold text-gray-400 mb-2">Private rooms</div>
            {% if chat_blocked %}
                <div class="bg-gray-900/40 border border-gray-800 rounded-xl p-3 text-xs text-gray-300 mb-4">
                    Private chats are disabled for your account.
                </div>
            {% else %}
                <div class="space-y-2 mb-4">
                    <form method="post" action="{% url 'private-room-create' %}" class="space-y-2">
                        {% csrf_token %}
                        {{ private_room_create_form.name }}
                        <button type="submit" class="w-full bg-gray-800 hover:bg-gray-700 text-white rounded-lg px-3 py-2 text-sm transition-colors">
                            Create private room
                        </button>
                    </form>

                    <form method="post" action="{% url 'private-room-join' %}" class="space-y-2">
                        {% csrf_token %}
                        {{ room_code_join_form.code }}
                        <button type="submit" class="w-full bg-gray-800 hover:bg-gray-700 text-white rounded-lg px-3 py-2 text-sm transition-colors">
                            Enter room code
                        </button>
                    </form>
                </div>
            {% endif %}

            {% if sidebar_code_rooms %}
                <div class="text-xs font-semibold text-gray-400 mb-2">Your private rooms</div>
                <ul class="space-y-1 mb-4">
                    {% for room in sidebar_code_rooms %}
                        <li>
                            <a data-chat-list-item href="{% url 'chatroom' room.group_name %}"
                                         data-private-room-item
                                         data-private-room-group="{{ room.group_name }}"
                                         {% if user == room.admin or user.is_staff %}data-private-room-rename-url="{% url 'private-room-rename' room.group_name %}"{% endif %}
                                         class="block pr-3 py-2 rounded-lg text-sm hover:bg-gray-800/60 transition-colors
                                         {% if chat_group.group_name == room.group_name %}pl-2 border-l-4 border-indigo-500 bg-indigo-500/10 text-emerald-400 font-semibold{% else %}px-3 text-gray-300{% endif %}">
                                <span data-private-room-title-for="{{ room.group_name }}">{{ room.code_room_name|default:room.room_code|slice:":30" }}</span>
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}

            {% if sidebar_privatechats %}
                <div class="text-xs font-semibold text-gray-400 mb-2">Direct</div>
                <ul class="space-y-1">
                    {% for room in sidebar_privatechats %}
                        <li>
                            <a data-chat-list-item href="{% url 'chatroom' room.group_name %}"
                               class="block pr-3 py-2 rounded-lg text-sm hover:bg-gray-800/60 transition-colors
                               {% if chat_group.group_name == room.group_name %}pl-2 border-l-4 border-indigo-500 bg-indigo-500/10 text-emerald-400 font-semibold{% else %}px-3 text-gray-300{% endif %}">
                                {% for member in room.members.all %}
                                    {% if member != user %}
                                        {{ member.profile.name|default:member.username|slice:":30" }}
                                    {% endif %}
                                {% endfor %}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
            </div>
        </aside>

        <div id="chat_window" class="vixo-chat-surface w-full min-w-0 max-w-full h-[calc(100dvh-6rem)] sm:h-[calc(100dvh-6.5rem)] min-h-0 flex flex-col bg-gray-900/60 border border-gray-800 rounded-2xl shadow-2xl relative p-1 grow overflow-x-hidden">
        
        <div id="chat_topbar" class="vixo-chat-surface flex items-center justify-between gap-2 text-emerald-400 bg-gray-900/60 p-2 sticky top-0 z-10 border-b border-gray-800 rounded-t-2xl">
            <div class="flex items-center min-w-0 flex-1">
                <button type="button" id="chat_sidebar_open" class="lg:hidden mr-2 inline-flex h-9 w-9 items-center justify-center rounded-lg bg-gray-800/60 hover:bg-gray-800 text-gray-100" aria-label="Open chats">
                    <span class="block w-5">
                        <span class="block h-0.5 w-5 bg-gray-100 rounded"></span>
                        <span class="block h-0.5 w-5 bg-gray-100 rounded mt-1"></span>
                        <span class="block h-0.5 w-5 bg-gray-100 rounded mt-1"></span>
                    </span>
                </button>

                {% if chat_group.is_code_room %}
                {% if user == chat_group.admin or user.is_staff %}
                    <div class="relative mr-2">
                        <button
                            type="button"
                            id="code_room_waiting_btn"
                            class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-gray-800/60 hover:bg-gray-800 text-gray-100 transition"
                            aria-label="Waiting list"
                            title="Waiting list"
                            data-waiting-list-url="{% url 'code-room-waiting-list' chatroom_name %}"
                            data-waiting-admit-url="{% url 'code-room-waiting-admit' chatroom_name %}"
                        >
                            <span class="text-base" aria-hidden="true">üë•</span>
                            <span
                                id="code_room_waiting_badge"
                                class="absolute -top-1 -right-1 min-w-[1.15rem] h-5 px-1 rounded-full bg-amber-500 text-white text-[11px] font-bold flex items-center justify-center shadow"
                                {% if code_room_waiting_count|default:0|add:0 == 0 %}style="display:none"{% endif %}
                            >{{ code_room_waiting_count|default:0 }}</span>
                        </button>

                        <div
                            id="code_room_waiting_panel"
                            class="hidden absolute left-0 mt-2 w-[18rem] rounded-2xl border border-gray-800 bg-gray-900/95 backdrop-blur-sm shadow-2xl overflow-hidden z-50"
                            role="dialog"
                            aria-label="Waiting list"
                        >
                            <div class="px-3 py-2 border-b border-gray-800 flex items-center justify-between">
                                <div class="text-xs font-semibold text-gray-100">Waiting list</div>
                                <button type="button" id="code_room_waiting_close" class="inline-flex h-7 w-7 items-center justify-center rounded-lg text-gray-300 hover:text-white hover:bg-gray-800/60" aria-label="Close">√ó</button>
                            </div>
                            <div id="code_room_waiting_body" class="max-h-[20rem] overflow-y-auto p-2">
                                <div class="text-xs text-gray-400 px-2 py-3">Loading‚Ä¶</div>
                            </div>
                        </div>
                    </div>
                {% endif %}
                {% endif %}
                <span id="online-count" class="pr-1 font-bold">{{ chat_group.users_online.count }}</span> online

                {% if chat_group.is_code_room %}
                    <span class="ml-3 text-xs text-gray-100 min-w-0 truncate inline-flex items-center gap-1" data-private-room-title-wrap>
                        <span class="text-gray-300">Room:</span>
                        <span id="vixo_private_room_title" class="font-semibold text-gray-100 truncate">{{ chat_group.code_room_name|default:chat_group.room_code|default:chat_group.group_name }}</span>
                        {% if user == chat_group.admin or user.is_staff %}
                            <button
                                type="button"
                                class="ml-1 hidden sm:inline-flex h-6 w-6 items-center justify-center rounded-md bg-gray-800/60 hover:bg-gray-800 text-gray-100"
                                title="Rename room"
                                aria-label="Rename room"
                                data-private-room-rename
                                data-private-room-group="{{ chat_group.group_name }}"
                                data-private-room-rename-url="{% url 'private-room-rename' chatroom_name %}"
                            >‚úèÔ∏è</button>
                        {% endif %}
                    </span>
                {% endif %}

                {% if chat_group.is_code_room and chat_group.room_code %}
                    <span class="ml-3 text-xs text-gray-300 min-w-0 truncate" data-room-code-wrap>
                        <span class="hidden sm:inline">Room code:</span>
                        <button
                            type="button"
                            class="font-semibold text-emerald-400 hover:text-emerald-300 underline-offset-2 hover:underline cursor-pointer truncate max-w-[7.5rem] align-bottom"
                            data-room-code-copy="{{ chat_group.room_code }}"
                            title="Click to copy"
                            aria-label="Copy room code"
                        >{{ chat_group.room_code }}</button>
                        <span data-room-code-copied class="ml-2 inline-block text-[10px] font-semibold text-emerald-300 transition-all duration-200 ease-out opacity-0 -translate-y-0.5 scale-95 invisible">Code copied</span>
                    </span>
                {% endif %}
            </div>

            <div class="flex items-center gap-2 justify-end shrink-0 flex-nowrap whitespace-nowrap">
                {% if chat_group.is_private and not chat_blocked %}
                    <button type="button" id="challenge_drawer_open" class="h-8 text-[11px] sm:text-xs bg-emerald-600 hover:bg-emerald-700 text-white px-2.5 sm:px-3 rounded-lg transition-colors whitespace-nowrap">
                        üéÆ <span class="hidden sm:inline">Challenge</span>
                    </button>
                    <button type="button" id="challenge_cancel_btn" class="h-8 text-[11px] sm:text-xs bg-gray-800 hover:bg-gray-700 text-white px-2.5 sm:px-3 rounded-lg transition-colors hidden whitespace-nowrap">
                        <span class="sm:hidden">End</span><span class="hidden sm:inline">End</span>
                    </button>
                    <span id="challenge_countdown" class="hidden text-[10px] sm:text-[11px] font-semibold text-emerald-200 bg-emerald-500/10 border border-emerald-500/20 px-2 py-1 rounded-full transition duration-200 ease-out opacity-0 scale-95 whitespace-nowrap"></span>

                    <div class="flex items-center gap-2 flex-nowrap whitespace-nowrap">
                        <a data-call-btn data-call-type="voice" href="#" class="text-[11px] sm:text-xs bg-gray-800 hover:bg-gray-700 text-white px-2.5 py-1.5 rounded-lg transition-colors whitespace-nowrap">
                            <span class="sm:hidden">Voice</span><span class="hidden sm:inline">Voice call</span>
                        </a>
                        <a data-call-btn data-call-type="video" href="#" class="text-[11px] sm:text-xs bg-gray-800 hover:bg-gray-700 text-white px-2.5 py-1.5 rounded-lg transition-colors whitespace-nowrap">
                            <span class="sm:hidden">Video</span><span class="hidden sm:inline">Video call</span>
                        </a>
                    </div>
                {% endif %}

                {% if chat_group.admin and user == chat_group.admin or user.is_staff %}
                    <form method="post" action="{% url 'chatroom-close' chatroom_name %}"
                          data-confirm="Close this room? This will delete the room and all messages/uploads."
                          data-confirm-title="Close room">
                        {% csrf_token %}
                        <button type="submit" class="text-xs bg-gray-800 hover:bg-gray-700 text-white px-3 py-1.5 rounded-lg transition-colors whitespace-nowrap">
                            Close room
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>

        {% if chat_group.is_private %}
            <div class="px-4 py-1.5 text-[11px] text-gray-300/90 flex items-center justify-center gap-1 flex-wrap">
                <span aria-hidden="true">üîí</span>
                <span class="hidden sm:inline">End-to-End encrypted</span>
                <span class="sm:hidden">Encrypted</span>

                {% if chat_group.is_code_room and chat_group.room_code %}
                    <span class="mx-1 text-gray-500 sm:hidden">‚Ä¢</span>
                    <span class="text-gray-300 sm:hidden">Code:</span>
                    <span class="inline-flex items-center gap-2 sm:hidden" data-room-code-wrap>
                        <button
                            type="button"
                            class="font-semibold text-emerald-400 hover:text-emerald-300 underline-offset-2 hover:underline cursor-pointer"
                            data-room-code-copy="{{ chat_group.room_code }}"
                            title="Click to copy"
                            aria-label="Copy room code"
                        >{{ chat_group.room_code }}</button>
                        <span data-room-code-copied class="inline-block text-[10px] font-semibold text-emerald-300 transition-all duration-200 ease-out opacity-0 -translate-y-0.5 scale-95 invisible">Code copied</span>
                    </span>
                {% endif %}
            </div>
        {% endif %}

        {% if chat_group.is_code_room and chat_group.room_code and request.GET.created == '1' %}
            <div id="room_share_hint" class="hidden mx-2 mt-2 rounded-xl border border-emerald-500/30 bg-emerald-500/10 px-4 py-3 text-sm text-emerald-100 opacity-0 -translate-y-2 transition duration-300">
                <div class="flex items-center justify-between gap-3 flex-wrap">
                    <div class="font-semibold">Share this code to your friends to join this room</div>
                    <span class="inline-flex items-center gap-2" data-room-code-wrap>
                        <button
                            type="button"
                            class="inline-flex items-center gap-2 rounded-lg bg-emerald-500 text-white px-3 py-1.5 text-xs font-semibold hover:bg-emerald-600 transition"
                            data-room-code-copy="{{ chat_group.room_code }}"
                            title="Click to copy"
                        >Copy {{ chat_group.room_code }}</button>
                        <span data-room-code-copied class="inline-block text-xs font-semibold text-emerald-200 transition-all duration-200 ease-out opacity-0 -translate-y-0.5 scale-95 invisible">Code copied</span>
                    </span>
                </div>
            </div>
        {% endif %}

        {% if chat_group.pinned_message %}
            <div class="vixo-chat-surface mx-2 mt-2 rounded-xl border border-gray-800 bg-gray-900/50 px-3 py-2">
                <div class="flex items-center gap-2 text-xs font-semibold text-emerald-300">
                    <span aria-hidden="true">üìå</span>
                    <span>Pinned</span>
                </div>
                <div class="mt-1 text-xs text-gray-200 whitespace-pre-wrap">{{ chat_group.pinned_message }}</div>
            </div>
        {% endif %}

        <div id='chat_container' class="vixo-chat-bg overflow-y-auto overflow-x-hidden overscroll-x-none grow p-3 sm:p-4 vixo-chat-init-hidden">
            <div id="challenge_banner" class="hidden sticky top-0 z-10 mb-3 transition duration-200 ease-out opacity-0 -translate-y-1">
                <div class="rounded-xl border border-emerald-500/20 bg-emerald-500/10 px-3 py-2 text-xs text-emerald-50">
                    <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0">
                            <div class="font-semibold text-emerald-200" id="challenge_banner_title">Challenge</div>
                            <div class="mt-0.5 text-emerald-50/90 whitespace-pre-wrap" id="challenge_banner_desc"></div>
                            <div class="mt-1 text-[11px] font-semibold" id="challenge_banner_self"></div>
                        </div>
                        <div class="shrink-0 text-[11px] font-semibold bg-emerald-500/10 border border-emerald-500/20 px-2 py-1 rounded-full" id="challenge_banner_time"></div>
                    </div>
                </div>
            </div>
            {% if chat_messages %}
                <ul id='chat_messages' data-chat-feed class="flex flex-col justify-end gap-2">
                    {% for message in chat_messages %}
                        {% with prev=chat_messages|slice:forloop.counter0|last %}
                            {% include 'a_rtchat/chat_message.html' with prev_message=prev %}
                        {% endwith %}
                    {% endfor %}
                </ul>
            {% else %}
                <ul id='chat_messages' data-chat-feed class="hidden"></ul>
                <div id="empty_state" class="min-h-[16rem] sm:min-h-[28rem] flex items-center justify-center">
                    <div class="text-center max-w-md">
                        <div class="text-2xl font-extrabold text-gray-100">
                            {% if chat_group.groupchat_name %}
                                {{ chat_group.groupchat_name }}
                            {% elif chat_group.is_private %}
                                Private Space
                            {% elif chat_group.is_code_room and chat_group.code_room_name %}
                                {{ chat_group.code_room_name }}
                            {% elif chat_group.is_code_room and chat_group.room_code %}
                                {{ chat_group.room_code }}
                            {% elif chat_group.group_name == 'public-chat' %}
                                Public chat
                            {% else %}
                                {{ chat_group.group_name }}
                            {% endif %}
                        </div>
                        <div class="mt-3 text-sm text-gray-300">Talk about anything. Chill vibes only.</div>
                        <div class="mt-2 text-sm text-gray-400">Say hi to start the conversation</div>
                    </div>
                </div>
            {% endif %}
        </div>

        {% if chat_group.is_private %}
            <button
                type="button"
                id="vixo_private_newmsg_jump"
                class="hidden vixo-private-newmsg-indicator absolute left-1/2 -translate-x-1/2 bottom-24 sm:bottom-28 z-20"
                aria-label="Jump to latest message"
            >
                <span class="vixo-private-newmsg-bubble" aria-hidden="true">
                    <img src="{% static 'favicon.png' %}" alt="" class="vixo-private-newmsg-logo" loading="lazy" decoding="async" />
                </span>
                <span class="vixo-private-newmsg-arrow" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M6 9l6 6 6-6" />
                    </svg>
                </span>
            </button>
        {% endif %}

        <div id="chat_composer_bar" class="vixo-chat-surface vixo-chat-composer sticky bottom-0 z-10 p-4 bg-gray-900/60 border-t border-gray-800 rounded-b-2xl">
            <div id="reply_bar" class="hidden mb-2 rounded-xl border border-gray-800 bg-gray-900/80 px-3 py-2">
                <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                        <div class="text-[10px] font-semibold text-emerald-400">Replying to <span id="reply_bar_author" class="text-gray-200"></span></div>
                        <div id="reply_bar_preview" class="text-[11px] text-gray-400 truncate"></div>
                    </div>
                    <button type="button" id="reply_bar_cancel" class="text-gray-300 hover:text-white px-2">√ó</button>
                </div>
            </div>

            <div id="edit_bar" class="hidden mb-2 rounded-xl border border-gray-800 bg-gray-900/80 px-3 py-2">
                <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                        <div class="text-[10px] font-semibold text-emerald-400">Editing message</div>
                        <div id="edit_bar_preview" class="text-[11px] text-gray-400 truncate"></div>
                    </div>
                    <button type="button" id="edit_bar_cancel" class="text-gray-300 hover:text-white px-2">√ó</button>
                </div>
            </div>

            <div id="typing_indicator" class="hidden mb-2 text-[11px] text-gray-400">
                <span id="typing_indicator_text"></span>
            </div>

            {% if chat_blocked %}
                <div class="bg-gray-900/40 border border-gray-800 rounded-xl px-4 py-3 text-sm text-gray-200">
                    You can view messages, but you are blocked from sending messages.
                </div>
            {% elif needs_email_verification_for_chat %}
                <div class="bg-gray-900/40 border border-gray-800 rounded-xl px-4 py-3 text-sm text-gray-200">
                    Verify your email to continue chatting.
                    <a href="{% url 'profile-settings' %}" class="ml-2 inline-flex items-center text-emerald-400 hover:text-emerald-300 font-semibold">Verify now</a>
                </div>
            {% elif chat_muted_seconds and chat_muted_seconds > 0 %}
                <div class="bg-gray-900/40 border border-gray-800 rounded-xl px-4 py-3 text-sm text-gray-200">
                    You are on cooldown for <span class="font-semibold text-emerald-400">{{ chat_muted_seconds }}s</span>. Please wait.
                </div>
            {% else %}
                <form id="chat_message_form" class="flex flex-col gap-2" data-no-loading
                    hx-post="{{ request.path }}"
                    hx-target="#chat_messages"
                    hx-swap="beforeend"
                    hx-encoding="multipart/form-data"
                    >
                    {% csrf_token %}

                    <input type="hidden" name="reply_to_id" id="reply_to_id" value="" />
                    <input type="hidden" name="typed_ms" id="typed_ms" value="" />
                    <input type="hidden" id="chat_file_caption" name="caption" value="" />
                    <input type="hidden" id="chat_one_time_seconds" name="one_time_seconds" value="" />

                    <div class="flex items-center gap-2 flex-nowrap">
                        <div id="chat_body_wrap" class="flex-1 min-w-0">
                            <div class="relative flex items-center gap-2">
                                {{ form.body }}

                                {% if gifs_allowed %}
                                    <button
                                        type="button"
                                        id="gif_btn"
                                        class="absolute right-3 top-1/2 -translate-y-1/2 h-8 w-8 inline-flex items-center justify-center rounded-full bg-gray-800/40 text-gray-200 hover:text-white hover:bg-gray-800/70 transition"
                                        aria-label="GIF"
                                        title="GIF"
                                    >
                                        <span class="text-[11px] font-extrabold">GIF</span>
                                    </button>

                                    <div
                                        id="gif_panel"
                                        class="hidden opacity-0 scale-95 pointer-events-none transition duration-150 ease-out fixed sm:absolute bottom-24 sm:bottom-full right-3 sm:right-0 sm:mb-2 origin-bottom-right w-[min(24rem,calc(100vw-1.5rem))] sm:w-[min(24rem,calc(100vw-3rem))] max-h-[70vh] overflow-hidden overscroll-contain rounded-xl border border-gray-800 bg-gray-900/95 shadow-lg shadow-black/30 z-50"
                                        role="dialog"
                                        aria-label="GIF picker"
                                    >
                                        <div class="flex items-center justify-between gap-2 px-3 py-2 border-b border-gray-800">
                                            <div class="text-sm font-semibold text-gray-100">GIFs</div>
                                            <button type="button" id="gif_close" class="h-8 w-8 rounded-lg bg-gray-800/60 hover:bg-gray-800 text-gray-200 inline-flex items-center justify-center" aria-label="Close GIF picker">√ó</button>
                                        </div>
                                        <div class="p-3">
                                            <input
                                                id="gif_search"
                                                type="text"
                                                autocomplete="off"
                                                placeholder="Search GIFs..."
                                                class="w-full bg-white/5 text-white border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500/30 placeholder:text-gray-400"
                                            />
                                            <div id="gif_status" class="mt-2 text-[11px] text-gray-400"></div>
                                            <div id="gif_results" class="mt-3 grid grid-cols-2 gap-2 overflow-y-auto max-h-[52vh] pr-1"></div>
                                        </div>
                                    </div>
                                {% endif %}

                                <div
                                    id="mention_panel"
                                    class="hidden absolute bottom-full left-0 mb-2 w-[min(22rem,calc(100vw-3rem))] rounded-xl border border-gray-800 bg-gray-900/95 shadow-lg shadow-black/30 p-1 z-30"
                                    role="listbox"
                                    aria-label="Mention suggestions"
                                >
                                    <div id="mention_list" class="max-h-64 overflow-y-auto"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 justify-end shrink-0">
                            {% if uploads_allowed %}
                                <button
                                    type="button"
                                    id="chat_upload_btn"
                                    class="h-11 w-11 inline-flex items-center justify-center rounded-full bg-gray-800/50 text-white transition duration-150 ease-out hover:bg-gray-800/70 hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-emerald-500/40"
                                    aria-label="Upload"
                                    title="Upload"
                                    {% if uploads_remaining == 0 %}disabled{% endif %}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                        <polyline points="17 8 12 3 7 8" />
                                        <line x1="12" x2="12" y1="3" y2="15" />
                                    </svg>
                                </button>
                            {% endif %}
                            <div class="relative shrink-0">
                                <button
                                    type="button"
                                    id="emoji_btn"
                                    class="h-11 w-11 inline-flex items-center justify-center rounded-full bg-gray-800/50 text-white transition duration-150 ease-out hover:bg-gray-800/70 hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-emerald-500/40"
                                    aria-label="Insert emoji"
                                    aria-haspopup="dialog"
                                    aria-expanded="false"
                                >
                                    üòä
                                </button>

                                <div
                                    id="emoji_panel"
                                    class="hidden opacity-0 scale-95 pointer-events-none transition duration-150 ease-out fixed sm:absolute bottom-24 sm:bottom-full right-3 sm:right-0 sm:mb-2 w-[min(20rem,calc(100vw-1.5rem))] sm:w-[min(20rem,calc(100vw-3rem))] max-h-[70vh] overflow-y-auto overscroll-contain rounded-xl border border-gray-800 bg-gray-900/95 shadow-lg shadow-black/30 p-3 z-30"
                                    role="dialog"
                                    aria-label="Emoji picker"
                                >
                                    <div id="emoji_mart_mount"></div>
                                </div>
                            </div>

                            <button
                                id="chat_send_btn"
                                type="submit"
                                class="h-11 w-11 inline-flex items-center justify-center rounded-full bg-emerald-500 hover:bg-emerald-600 text-white transition duration-150 ease-out hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-emerald-500/40"
                                aria-label="Send"
                                title="Send"
                            >
                                <span class="sr-only">Send</span>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                                    <path d="M22 2 11 13" />
                                    <path d="M22 2 15 22 11 13 2 9 22 2" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div id="chat_send_cooldown_notice" class="hidden text-xs text-amber-300">
                        Cooldown: <span id="chat_send_cooldown_seconds" class="font-semibold">0</span>s
                    </div>

                    {% if uploads_allowed %}
                        <div class="mt-1">
                            <input id="chat_file_input" name="file" type="file" accept="image/*,video/mp4,video/webm,video/ogg,video/quicktime" class="sr-only" {% if uploads_remaining == 0 %}disabled{% endif %} />

                            {% if upload_limit %}
                                <div id="upload_counter" class="text-xs text-gray-400" data-used="{{ uploads_used }}" data-limit="{{ upload_limit }}">
                                    Upload ({{ uploads_used }}/{{ upload_limit }} used)
                                </div>
                            {% endif %}

                            <div id="upload_feedback" class="mt-2"></div>
                            <div id="upload_limit_reached_msg" class="text-xs text-gray-400 mt-1{% if uploads_remaining != 0 %} hidden{% endif %}">Upload limit reached for this room.</div>
                        </div>
                    {% endif %}
                </form>
            {% endif %}
        </div>
        </div>

    </div>
</wrapper>

{% if chat_group.is_private and not chat_blocked %}
    <!-- Challenge drawer overlay (kept near end of DOM to avoid stacking-context clashes) -->
    <div id="challenge_drawer" class="fixed inset-0 z-[80] flex items-end sm:items-center justify-center p-3 sm:p-6 transition-opacity duration-200 ease-out opacity-0 pointer-events-none">
        <div id="challenge_drawer_backdrop" class="absolute inset-0 bg-black/40 transition-opacity duration-200 ease-out opacity-0"></div>
        <div id="challenge_drawer_panel" class="relative w-full sm:max-w-md rounded-2xl border border-gray-800 bg-gray-900/95 backdrop-blur-sm shadow-2xl overflow-hidden
                max-h-[78vh] sm:max-h-[85vh] flex flex-col
                transform transition duration-200 ease-out
                translate-y-8 sm:translate-y-2 sm:scale-95 opacity-0">

            <div class="flex-shrink-0 flex items-center justify-between gap-3 p-4 border-b border-gray-800/50">
                <div>
                    <div class="text-base font-semibold text-emerald-200">Start a Challenge</div>
                    <div class="mt-0.5 text-[11px] text-gray-400">30 seconds, realtime judging</div>
                </div>
                <button type="button" id="challenge_drawer_close"
                        class="h-8 w-8 rounded-lg bg-gray-800/60 hover:bg-gray-800 text-gray-300 hover:text-gray-100 flex items-center justify-center transition-colors flex-shrink-0"
                        aria-label="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto px-4 py-3">
                <div class="grid grid-cols-1 gap-2.5">
                    <button type="button" data-challenge-kind="truth_or_dare" class="text-left rounded-lg border border-emerald-500/20 bg-emerald-500/5 hover:bg-emerald-500/15 active:scale-95 transition p-3 group">
                        <div class="text-sm font-semibold text-gray-100 group-hover:text-emerald-200">üé≠ Truth or Dare</div>
                        <div class="mt-1 text-xs text-gray-400 group-hover:text-gray-300">Answer meaningfully or follow the dare.</div>
                    </button>
                    <button type="button" data-challenge-kind="finish_meme" class="text-left rounded-lg border border-purple-500/20 bg-purple-500/5 hover:bg-purple-500/15 active:scale-95 transition p-3 group">
                        <div class="text-sm font-semibold text-gray-100 group-hover:text-purple-200">üòÇ Finish the Meme</div>
                        <div class="mt-1 text-xs text-gray-400 group-hover:text-gray-300">First meaningful reply wins.</div>
                    </button>
                    <button type="button" data-challenge-kind="emoji_only" class="text-left rounded-lg border border-yellow-500/20 bg-yellow-500/5 hover:bg-yellow-500/15 active:scale-95 transition p-3 group">
                        <div class="text-sm font-semibold text-gray-100 group-hover:text-yellow-200">üòä Emoji-only</div>
                        <div class="mt-1 text-xs text-gray-400 group-hover:text-gray-300">Only emojis allowed. Any letter = fail.</div>
                    </button>
                    <button type="button" data-challenge-kind="no_vowels" class="text-left rounded-lg border border-blue-500/20 bg-blue-500/5 hover:bg-blue-500/15 active:scale-95 transition p-3 group">
                        <div class="text-sm font-semibold text-gray-100 group-hover:text-blue-200">üö´ No Vowels</div>
                        <div class="mt-1 text-xs text-gray-400 group-hover:text-gray-300">A/E/I/O/U banned. First vowel = fail.</div>
                    </button>
                    <button type="button" data-challenge-kind="time_attack" class="text-left rounded-lg border border-orange-500/20 bg-orange-500/5 hover:bg-orange-500/15 active:scale-95 transition p-3 group">
                        <div class="text-sm font-semibold text-gray-100 group-hover:text-orange-200">‚ö° Time Attack</div>
                        <div class="mt-1 text-xs text-gray-400 group-hover:text-gray-300">Send 3 messages in 30 seconds.</div>
                    </button>
                </div>
            </div>

            <div class="flex-shrink-0 border-t border-gray-800/50 p-3 text-[11px] text-gray-400 bg-gray-900/40">
                Only one challenge active per chat. Higher stakes, higher rewards.
            </div>
        </div>
    </div>
{% endif %}

<!-- Draggable call popup (WhatsApp-like) -->
<div id="call_popup" class="hidden fixed bottom-4 right-4 sm:bottom-6 sm:right-6 z-50 w-[min(20rem,calc(100vw-2rem))] h-[min(20rem,calc(100vw-2rem))] sm:w-80 sm:h-80 rounded-2xl border border-gray-800 bg-gray-900/95 shadow-2xl overflow-hidden">
    <div id="call_popup_header" class="px-3 py-2 bg-gray-900/90 border-b border-gray-800 flex items-center justify-between cursor-move select-none">
        <div class="min-w-0">
            <div id="call_popup_title" class="text-xs font-semibold text-gray-100 truncate">Call</div>
            <div id="call_popup_subtitle" class="text-[10px] text-gray-400 truncate">Connecting‚Ä¶</div>
        </div>
        <div class="flex items-center gap-1">
            <button id="call_popup_mic" type="button" class="text-[11px] bg-gray-800 hover:bg-gray-700 text-white px-2.5 py-1.5 rounded-lg transition-colors">Mute</button>
            <button id="call_popup_cam" type="button" class="text-[11px] bg-gray-800 hover:bg-gray-700 text-white px-2.5 py-1.5 rounded-lg transition-colors">Cam Off</button>
            <button id="call_popup_switch" type="button" class="text-[11px] bg-gray-800 hover:bg-gray-700 text-white px-2.5 py-1.5 rounded-lg transition-colors">Switch</button>
            <button id="call_popup_end" type="button" class="text-[11px] bg-red-600/90 hover:bg-red-600 text-white px-2.5 py-1.5 rounded-lg transition-colors">End</button>
        </div>
    </div>
    <div class="p-3 h-[calc(100%-44px)]">
        <div id="call_popup_status" class="text-[11px] text-gray-400"></div>
        <div id="call_popup_video" class="hidden mt-3 grid-cols-2 gap-2 h-[calc(100%-26px)]">
            <div class="rounded-xl border border-gray-800 bg-black/30 overflow-hidden h-full">
                <div id="call_local_player" class="w-full h-full"></div>
            </div>
            <div class="rounded-xl border border-gray-800 bg-black/30 overflow-hidden h-full">
                <div id="call_remote_player" class="w-full h-full"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>

{% if uploads_allowed %}
    <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css">
    <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>

    <!-- Upload preview + crop modal -->
    <div id="upload_modal" class="hidden fixed inset-0 z-[90]">
        <div id="upload_modal_backdrop" class="absolute inset-0 bg-black/60"></div>
        <div class="absolute inset-0 flex items-end sm:items-center justify-center p-3 sm:p-6">
            <div class="w-full sm:max-w-lg rounded-2xl border border-gray-800 bg-gray-900/95 shadow-2xl overflow-hidden">
                <div class="flex items-center justify-between gap-3 p-4 border-b border-gray-800/60">
                    <div class="flex items-center gap-2 min-w-0">
                        <div class="text-sm font-semibold text-gray-100">Preview</div>
                        <div id="upload_one_time_badge" class="hidden text-[11px] px-2 py-1 rounded-full border border-emerald-500/25 bg-emerald-500/10 text-emerald-200 whitespace-nowrap">
                            1√ó
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        {% if chat_group.is_private %}
                            <div class="relative">
                                <button
                                    type="button"
                                    id="upload_one_time_btn"
                                    class="h-8 w-8 rounded-lg bg-gray-800/60 hover:bg-gray-800 text-gray-300 hover:text-gray-100 flex items-center justify-center transition"
                                    aria-label="One-time view"
                                    title="One-time view"
                                >
                                    ‚è±Ô∏è
                                </button>
                                <div
                                    id="upload_one_time_panel"
                                    class="hidden opacity-0 scale-95 pointer-events-none transition duration-150 ease-out absolute right-0 mt-2 w-48 rounded-xl border border-gray-800 bg-gray-900/95 shadow-lg shadow-black/30 p-2 z-30"
                                    role="dialog"
                                    aria-label="One-time view duration"
                                >
                                    <div class="text-[11px] text-gray-400 px-1 pb-2">One-time view</div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button type="button" data-one-time-seconds="3" class="h-9 rounded-lg bg-gray-800 hover:bg-gray-700 text-white text-sm transition">3s</button>
                                        <button type="button" data-one-time-seconds="8" class="h-9 rounded-lg bg-gray-800 hover:bg-gray-700 text-white text-sm transition">8s</button>
                                        <button type="button" data-one-time-seconds="15" class="h-9 rounded-lg bg-gray-800 hover:bg-gray-700 text-white text-sm transition">15s</button>
                                        <button type="button" data-one-time-seconds="" class="h-9 rounded-lg bg-gray-800/60 hover:bg-gray-700 text-gray-200 text-sm transition">Off</button>
                                    </div>
                                    <div class="pt-2 text-[10px] text-gray-500 px-1">Recipient can open once.</div>
                                </div>
                            </div>
                        {% endif %}
                        <button type="button" id="upload_modal_close" class="h-8 w-8 rounded-lg bg-gray-800/60 hover:bg-gray-800 text-gray-300 hover:text-gray-100 flex items-center justify-center" aria-label="Close">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4">
                                <path d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="p-4">
                    <div id="upload_modal_media_wrap" class="rounded-xl border border-gray-800 bg-black/30 overflow-hidden">
                        <img id="upload_modal_img" alt="" class="hidden w-full max-h-[55vh] object-contain" />
                        <video id="upload_modal_video" class="hidden w-full max-h-[55vh]" playsinline controls></video>
                    </div>

                    <div class="mt-3">
                        <input
                            id="upload_modal_caption"
                            type="text"
                            maxlength="300"
                            placeholder="Add a caption (optional)‚Ä¶"
                            class="w-full bg-gray-800/70 text-white border border-gray-700 rounded-lg px-4 py-3 outline-none focus:border-emerald-500 placeholder:text-gray-400"
                        />
                        <div id="upload_modal_hint" class="mt-2 text-[11px] text-gray-400"></div>
                    </div>
                </div>

                <div class="flex items-center justify-between gap-2 p-3 border-t border-gray-800/60 bg-gray-900/40">
                    <button type="button" id="upload_modal_cancel" class="h-10 px-4 rounded-lg bg-gray-800 hover:bg-gray-700 text-white text-sm">Cancel</button>
                    <button type="button" id="upload_modal_send" class="h-10 px-4 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-semibold">Send</button>
                </div>
            </div>
        </div>
    </div>
{% endif %}
{% comment %}
LEGACY INLINE SCRIPT REMOVED (moved to static/js/chat.js)
    (function () {
        const chatroomName = "{{ chatroom_name|escapejs }}";
        const currentUserId = parseInt("{{ user.id|default:0 }}", 10) || 0;
        let lastOtherReadId = parseInt("{{ other_last_read_id|default:0 }}", 10) || 0;
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsUrl = `${wsScheme}://${window.location.host}/ws/chatroom/${chatroomName}`;
        const pollUrl = "{% url 'chat-poll' chatroom_name %}";
        const inviteUrl = "{% url 'chat-call-invite' chatroom_name %}";
        const tokenUrl = "{% url 'agora-token' chatroom_name %}";
        const presenceUrl = "{% url 'chat-call-presence' chatroom_name %}";

        (function initChatEmojiPicker() {
            const btn = document.getElementById('emoji_btn');
            const panel = document.getElementById('emoji_panel');
            const input = document.getElementById('id_body');

            if (!btn || !panel || !input) return;

            const open = () => {
                panel.classList.remove('hidden');
                btn.setAttribute('aria-expanded', 'true');
            };
            const close = () => {
                panel.classList.add('hidden');
                btn.setAttribute('aria-expanded', 'false');
            };
            const toggle = () => {
                if (panel.classList.contains('hidden')) open();
                else close();
            };

            function insertAtCursor(text) {
                const start = input.selectionStart ?? input.value.length;
                const end = input.selectionEnd ?? input.value.length;
                const before = input.value.slice(0, start);
                const after = input.value.slice(end);
                input.value = before + text + after;
                const nextPos = start + text.length;
                try {
                    input.setSelectionRange(nextPos, nextPos);
                } catch (e) {}
                try { input.focus(); } catch (e) {}
            }

            btn.addEventListener('click', (e) => {
                e.preventDefault();
                toggle();
            });

            panel.addEventListener('click', (e) => {
                const target = e.target && e.target.closest ? e.target.closest('[data-emoji]') : null;
                if (!target) return;
                const emoji = target.getAttribute('data-emoji') || '';
                if (!emoji) return;
                insertAtCursor(emoji);
                close();
            });

            document.addEventListener('click', (e) => {
                const t = e.target;
                if (!t) return;
                if (panel.contains(t) || btn.contains(t)) return;
                close();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') close();
            });
        })();

        (function initMentionAutocomplete() {
            const input = document.getElementById('id_body');
            const panel = document.getElementById('mention_panel');
            const list = document.getElementById('mention_list');
            const url = "{% url 'mention-search' %}";

            if (!input || !panel || !list) return;

            let open = false;
            let activeIndex = 0;
            let results = [];
            let current = null; // { atIndex, caret }
            let debounceTimer = null;
            let abortController = null;

            function isOpen() {
                return open && !panel.classList.contains('hidden');
            }

            function close() {
                open = false;
                results = [];
                current = null;
                activeIndex = 0;
                panel.classList.add('hidden');
                list.innerHTML = '';
            }

            function show() {
                open = true;
                panel.classList.remove('hidden');
            }

            function getMentionContext() {
                const caret = input.selectionStart ?? (input.value || '').length;
                const before = (input.value || '').slice(0, caret);
                const atIndex = before.lastIndexOf('@');
                if (atIndex < 0) return null;
                if (atIndex > 0) {
                    const prev = before[atIndex - 1];
                    if (prev && !/\s/.test(prev)) return null;
                }
                const raw = before.slice(atIndex + 1);
                if (!raw) return null;
                if (/\s/.test(raw)) return null;
                if (!/^[A-Za-z0-9_.-]{1,32}$/.test(raw)) return null;
                return { atIndex, caret, q: raw };
            }

            function render() {
                if (!results.length) {
                    close();
                    return;
                }
                show();
                const safeIndex = Math.max(0, Math.min(activeIndex, results.length - 1));
                activeIndex = safeIndex;

                list.innerHTML = results
                    .map((r, idx) => {
                        const active = idx === activeIndex;
                        const cls = active
                            ? 'bg-gray-800/80 text-white'
                            : 'hover:bg-gray-800/50 text-gray-200';
                        const avatar = r.avatar
                            ? `<img src="${r.avatar}" alt="" class="h-7 w-7 rounded-full border border-gray-800" />`
                            : `<div class="h-7 w-7 rounded-full border border-gray-800 bg-gray-800/70"></div>`;
                        const display = (r.display || r.username || '').toString();
                        const username = (r.username || '').toString();
                        return `
                            <button
                                type="button"
                                class="w-full flex items-center gap-2 px-3 py-2 rounded-lg text-left ${cls}"
                                data-idx="${idx}"
                            >
                                ${avatar}
                                <div class="min-w-0">
                                    <div class="text-sm font-semibold truncate">${display}</div>
                                    <div class="text-[11px] text-gray-400 truncate">@${username}</div>
                                </div>
                            </button>
                        `;
                    })
                    .join('');
            }

            function insertMention(username) {
                if (!current || !username) return;
                const value = input.value || '';
                const before = value.slice(0, current.atIndex);
                const after = value.slice(current.caret);
                const insert = `@${username} `;
                input.value = before + insert + after;
                const nextPos = (before + insert).length;
                try { input.setSelectionRange(nextPos, nextPos); } catch (e) {}
                try { input.focus(); } catch (e) {}
                close();
            }

            async function fetchResults(q) {
                if (abortController) {
                    try { abortController.abort(); } catch (e) {}
                }
                abortController = new AbortController();
                const resp = await fetch(`${url}?q=${encodeURIComponent(q)}`, {
                    credentials: 'same-origin',
                    signal: abortController.signal,
                    headers: { 'Accept': 'application/json' },
                });
                if (!resp.ok) return [];
                const data = await resp.json();
                return Array.isArray(data && data.results) ? data.results : [];
            }

            function schedule() {
                const ctx = getMentionContext();
                if (!ctx) {
                    close();
                    return;
                }
                current = { atIndex: ctx.atIndex, caret: ctx.caret };
                const q = ctx.q;

                if (debounceTimer) window.clearTimeout(debounceTimer);
                debounceTimer = window.setTimeout(async () => {
                    try {
                        const res = await fetchResults(q);
                        results = res || [];
                        activeIndex = 0;
                        render();
                    } catch (e) {
                        // ignore abort/network errors
                    }
                }, 150);
            }

            input.addEventListener('input', schedule);
            input.addEventListener('click', schedule);

            input.addEventListener('keydown', (e) => {
                if (!isOpen()) {
                    if (e.key === 'Escape') close();
                    return;
                }

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    activeIndex = Math.min(activeIndex + 1, results.length - 1);
                    render();
                    return;
                }
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    activeIndex = Math.max(activeIndex - 1, 0);
                    render();
                    return;
                }
                if (e.key === 'Enter' || e.key === 'Tab') {
                    const chosen = results[activeIndex];
                    if (chosen && chosen.username) {
                        e.preventDefault();
                        insertMention(chosen.username);
                    }
                    return;
                }
                if (e.key === 'Escape') {
                    e.preventDefault();
                    close();
                }
            });

            panel.addEventListener('click', (e) => {
                const btn = e.target && e.target.closest ? e.target.closest('button[data-idx]') : null;
                if (!btn) return;
                const idx = Number(btn.getAttribute('data-idx'));
                const chosen = results[idx];
                if (chosen && chosen.username) insertMention(chosen.username);
            });

            document.addEventListener('click', (e) => {
                const t = e.target;
                if (!t) return;
                if (panel.contains(t) || input.contains(t)) return;
                close();
            });
        })();

        // If server rate-limits message sends (429), show a countdown on the Send button.
        let sendCooldownTimer = null;
        function startSendCooldown(seconds) {
            const btn = document.getElementById('chat_send_btn');
            const input = document.getElementById('id_body');
            const caption = document.getElementById('chat_file_caption');
            const fileInput = document.getElementById('chat_file_input');
            const emojiBtn = document.getElementById('emoji_btn');
            const notice = document.getElementById('chat_send_cooldown_notice');
            const noticeSecs = document.getElementById('chat_send_cooldown_seconds');
            if (!btn || !input) return;

            if (!btn.dataset.originalText) {
                btn.dataset.originalText = (btn.textContent || 'Send').trim();
            }

            let remaining = Math.max(1, Number(seconds || 1));
            btn.disabled = true;
            input.disabled = true;
            if (caption) caption.disabled = true;
            if (fileInput) fileInput.disabled = true;
            if (emojiBtn) emojiBtn.disabled = true;
            if (notice) notice.classList.remove('hidden');

            const tick = () => {
                btn.textContent = `Wait ${remaining}s`;
                if (noticeSecs) noticeSecs.textContent = String(remaining);
                remaining -= 1;
                if (remaining < 0) {
                    window.clearInterval(sendCooldownTimer);
                    sendCooldownTimer = null;
                    btn.disabled = false;
                    input.disabled = false;
                    if (caption) caption.disabled = false;
                    if (fileInput) fileInput.disabled = false;
                    if (emojiBtn) emojiBtn.disabled = false;
                    btn.textContent = btn.dataset.originalText || 'Send';
                    if (notice) notice.classList.add('hidden');
                    try { input.focus(); } catch (e) {}
                }
            };

            if (sendCooldownTimer) window.clearInterval(sendCooldownTimer);
            tick();
            sendCooldownTimer = window.setInterval(tick, 1000);
        }

        // When a file is selected, switch the main form to upload mode.
        (function setupUploadModeSwitcher() {
            const msgForm = document.getElementById('chat_message_form');
            const fileInput = document.getElementById('chat_file_input');
            const captionWrap = document.getElementById('chat_file_caption_wrap');
            const captionInput = document.getElementById('chat_file_caption');
            const bodyWrap = document.getElementById('chat_body_wrap');
            const msgInput = (msgForm && msgForm.querySelector('[name="body"]')) || document.getElementById('id_body');

            if (!msgForm || !fileInput) return;

            function syncUploadMode() {
                const hasFile = !!(fileInput.files && fileInput.files.length);
                if (captionWrap) captionWrap.classList.toggle('hidden', !hasFile);
                if (bodyWrap) bodyWrap.classList.toggle('hidden', hasFile);
                if (!hasFile) {
                    if (captionInput) captionInput.value = '';
                    return;
                }
            }

            window.__syncUploadMode = syncUploadMode;
            fileInput.addEventListener('change', syncUploadMode);
            syncUploadMode();

            // If switching to upload mode and message box has text, move it into caption.
            fileInput.addEventListener('change', () => {
                const hasFile = !!(fileInput.files && fileInput.files.length);
                if (!hasFile) return;
                if (!captionInput) return;
                const cap = (captionInput.value || '').trim();
                const body = (msgInput && (msgInput.value || '').trim()) || '';
                if (!cap && body) {
                    captionInput.value = body.slice(0, 300);
                }
            });
        })();

        document.body.addEventListener('htmx:afterRequest', (event) => {
            const form = document.getElementById('chat_message_form');
            if (!form) return;
            if (event.target !== form) return;

            const xhr = event.detail.xhr;
            if (!xhr) return;

            // HTMX doesn't swap content on 4xx/5xx by default.
            // If we're in upload mode, show the response text in the upload feedback area.
            const fileInput = document.getElementById('chat_file_input');
            const inUploadMode = !!(fileInput && fileInput.files && fileInput.files.length);
            if (inUploadMode && xhr.status >= 400) {
                const feedback = document.getElementById('upload_feedback');
                if (feedback && xhr.responseText) {
                    feedback.innerHTML = xhr.responseText;
                }
            }
            if (xhr.status !== 429) return;

            const retryAfter = Number(xhr.getResponseHeader('Retry-After') || '10');
            startSendCooldown(Number.isFinite(retryAfter) ? retryAfter : 10);
        });

        // After a successful HTMX swap (used for file uploads), hydrate timestamps.
        document.body.addEventListener('htmx:afterSwap', (event) => {
            if (!messagesEl) return;
            if (event.target !== messagesEl) return;
            hydrateLocalTimes(messagesEl);
            updateLastIdFromDom();
            safeScrollToBottom();
        });

        const initialMuted = Number("{{ chat_muted_seconds|default:0 }}" || '0');
        if (Number.isFinite(initialMuted) && initialMuted > 0) {
            startSendCooldown(initialMuted);
        }
        const otherUsername = "{% if other_user %}{{ other_user.username|escapejs }}{% else %}{% endif %}";
        const callEventUrl = "{% url 'chat-call-event' chatroom_name %}";
        const messageEditUrlTemplate = "{% url 'message-edit' 0 %}";
        const messageDeleteUrlTemplate = "{% url 'message-delete' 0 %}";
        const messageReactUrlTemplate = "{% url 'message-react' 0 %}";

            // -------- Ringtone (incoming) --------
            let audioCtx = null;
            let ringTimer = null;
            let audioUnlocked = false;

            function unlockAudioOnce() {
                if (audioUnlocked) return;
                try {
                    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
                    // create a tiny silent buffer to unlock
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    g.gain.value = 0.00001;
                    o.connect(g);
                    g.connect(audioCtx.destination);
                    o.start();
                    o.stop(audioCtx.currentTime + 0.01);
                    audioUnlocked = true;
                } catch {
                    // ignore
                }
            }

            document.addEventListener('click', unlockAudioOnce, { once: true, capture: true });

            function stopIncomingRing() {
                if (ringTimer) {
                    clearInterval(ringTimer);
                    ringTimer = null;
                }
            }

            function playIncomingRing() {
                // Browsers may block until user interacts; we try best-effort.
                try {
                    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
                    if (audioCtx.state === 'suspended') audioCtx.resume().catch(() => {});
                } catch {
                    return;
                }

                stopIncomingRing();

                const ringOnce = () => {
                    try {
                        const ctx = audioCtx;
                        const now = ctx.currentTime;
                        const g = ctx.createGain();
                        g.gain.setValueAtTime(0.0001, now);
                        g.gain.exponentialRampToValueAtTime(0.15, now + 0.02);
                        g.gain.exponentialRampToValueAtTime(0.0001, now + 1.8);
                        g.connect(ctx.destination);

                        const o1 = ctx.createOscillator();
                        const o2 = ctx.createOscillator();
                        o1.type = 'sine';
                        o2.type = 'sine';
                        o1.frequency.setValueAtTime(480, now);
                        o2.frequency.setValueAtTime(620, now);
                        o1.connect(g);
                        o2.connect(g);
                        o1.start(now);
                        o2.start(now);
                        o1.stop(now + 1.9);
                        o2.stop(now + 1.9);
                    } catch {
                        // ignore
                    }
                };

                // Classic ring cadence: ring ~2s, pause ~3s
                ringOnce();
                ringTimer = setInterval(ringOnce, 5000);
            }

        const form = document.getElementById('chat_message_form');
        const input = document.getElementById('id_body');
        const typedMsInput = document.getElementById('typed_ms');
        const messagesEl = document.getElementById('chat_messages');
        const onlineCountEl = document.getElementById('online-count');

        const replyBar = document.getElementById('reply_bar');
        const replyBarAuthor = document.getElementById('reply_bar_author');
        const replyBarPreview = document.getElementById('reply_bar_preview');
        const replyBarCancel = document.getElementById('reply_bar_cancel');
        const replyToIdInput = document.getElementById('reply_to_id');

        const editBar = document.getElementById('edit_bar');
        const editBarPreview = document.getElementById('edit_bar_preview');
        const editBarCancel = document.getElementById('edit_bar_cancel');
        let editingMessageId = null;

        function startEditingMessage(messageId, body) {
            if (!input) return;
            editingMessageId = messageId;
            if (replyToIdInput) replyToIdInput.value = '';
            if (replyBar) replyBar.classList.add('hidden');

            if (editBarPreview) editBarPreview.textContent = (body || '').slice(0, 120);
            if (editBar) editBar.classList.remove('hidden');

            input.value = body || '';
            input.focus();
        }

        function cancelEditingMessage() {
            editingMessageId = null;
            if (editBar) editBar.classList.add('hidden');
            if (editBarPreview) editBarPreview.textContent = '';
        }

        if (editBarCancel) {
            editBarCancel.addEventListener('click', function () {
                cancelEditingMessage();
            });
        }

        const typingIndicatorEl = document.getElementById('typing_indicator');
        const typingIndicatorTextEl = document.getElementById('typing_indicator_text');
        const typingUsers = new Map();
        const typingTimers = new Map();
        let typingStopTimer = null;
        let lastTypingPingAt = 0;

        function renderTypingIndicator() {
            if (!typingIndicatorEl || !typingIndicatorTextEl) return;
            const names = Array.from(typingUsers.values()).filter(Boolean);
            if (!names.length) {
                typingIndicatorEl.classList.add('hidden');
                typingIndicatorTextEl.textContent = '';
                return;
            }
            typingIndicatorEl.classList.remove('hidden');
            typingIndicatorTextEl.textContent = `${names.join(', ')} typing...`;
        }

        function handleTypingEvent(payload) {
            const authorId = payload.author_id;
            if (!authorId) return;

            const username = (payload.username || '').trim();
            const isTyping = !!payload.is_typing;

            if (typingTimers.has(authorId)) {
                clearTimeout(typingTimers.get(authorId));
                typingTimers.delete(authorId);
            }

            if (isTyping) {
                typingUsers.set(authorId, username);
                typingTimers.set(authorId, setTimeout(() => {
                    typingUsers.delete(authorId);
                    typingTimers.delete(authorId);
                    renderTypingIndicator();
                }, 4000));
            } else {
                typingUsers.delete(authorId);
            }

            renderTypingIndicator();
        }

        function sendTyping(isTyping) {
            try {
                if (!socket || socket.readyState !== WebSocket.OPEN) return;
                socket.send(JSON.stringify({ type: 'typing', is_typing: !!isTyping }));
            } catch {
                // ignore
            }
        }

        if (input) {
            let typingStartedAt = null;
            input.addEventListener('input', () => {
                if (typingStartedAt === null && (input.value || '').trim().length > 0) {
                    typingStartedAt = Date.now();
                }
                const now = Date.now();
                if (now - lastTypingPingAt > 1200) {
                    sendTyping(true);
                    lastTypingPingAt = now;
                }
                if (typingStopTimer) clearTimeout(typingStopTimer);
                typingStopTimer = setTimeout(() => {
                    sendTyping(false);
                    typingStopTimer = null;
                }, 1800);
            });

            input.addEventListener('blur', () => {
                if (typingStopTimer) clearTimeout(typingStopTimer);
                typingStopTimer = null;
                sendTyping(false);
            });

            document.body.addEventListener('htmx:beforeRequest', (event) => {
                if (!form || event.target !== form) return;
                if (!typedMsInput) return;
                if (typingStartedAt === null) {
                    typedMsInput.value = '';
                    return;
                }
                const ms = Math.max(0, Date.now() - typingStartedAt);
                typedMsInput.value = String(ms);
            });

            document.body.addEventListener('htmx:afterRequest', (event) => {
                if (!form || event.target !== form) return;
                if (!event.detail.successful) return;
                typingStartedAt = null;
                if (typedMsInput) typedMsInput.value = '';
            });
        }

        if (form) {
            // Capture submit before HTMX when editing.
            form.addEventListener('submit', async (e) => {
                if (!editingMessageId) return;
                e.preventDefault();
                e.stopPropagation();

                const body = (input && input.value ? input.value : '').trim();
                if (!body) return;

                const url = messageEditUrlTemplate.replace('/0/', `/${editingMessageId}/`);
                try {
                    const params = new URLSearchParams();
                    params.set('body', body);
                    await fetch(url, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': (typeof getCookie === 'function' ? getCookie('csrftoken') : ''),
                        },
                        body: params,
                    });
                } catch {
                    // ignore
                }

                cancelEditingMessage();
                if (input) input.value = '';
                safeScrollToBottom();
            }, true);

            form.addEventListener('submit', () => {
                if (typingStopTimer) clearTimeout(typingStopTimer);
                typingStopTimer = null;
                sendTyping(false);
            });
        }

        let socket = null;
        let wsConnected = false;
        let lastId = 0;

        function sendReadAck(id) {
            if (!wsConnected || !socket) return;
            const last = parseInt(id || 0, 10) || 0;
            if (last <= 0) return;
            try {
                socket.send(JSON.stringify({ type: 'read', last_read_id: last }));
            } catch {
                // ignore
            }
        }

        function applyReadTicks(lastReadId) {
            const maxId = parseInt(lastReadId || 0, 10) || 0;
            if (maxId <= 0) return;
            const ticks = document.querySelectorAll('[data-read-tick][data-message-id]') || [];
            ticks.forEach((el) => {
                const mid = parseInt(el.getAttribute('data-message-id') || '0', 10) || 0;
                if (mid && mid <= maxId) el.textContent = '‚úì‚úì';
            });
        }

        function maybeAckReadIfVisible() {
            if (document.visibilityState !== 'visible') return;
            updateLastIdFromDom();
            sendReadAck(lastId);
        }

        function hydrateLocalTimes(root) {
            const container = root || document;
            const nodes = container.querySelectorAll ? container.querySelectorAll('time[data-dt]') : [];
            if (!nodes || !nodes.length) return;

            const timeFmt = new Intl.DateTimeFormat(undefined, {
                hour: '2-digit',
                minute: '2-digit',
            });
            const fullFmt = new Intl.DateTimeFormat(undefined, {
                dateStyle: 'medium',
                timeStyle: 'short',
            });

            nodes.forEach((el) => {
                const iso = el.getAttribute('data-dt');
                if (!iso) return;
                const d = new Date(iso);
                if (Number.isNaN(d.getTime())) return;

                el.textContent = timeFmt.format(d);
                // Hover tooltip for clarity across dates/timezones
                el.setAttribute('title', fullFmt.format(d));
                if (!el.getAttribute('datetime')) el.setAttribute('datetime', iso);
            });
        }

        function safeScrollToBottom() {
            if (typeof scrollToBottom === 'function') scrollToBottom();
        }

        function updateLastIdFromDom() {
            const last = messagesEl && messagesEl.lastElementChild;
            const id = last && last.dataset ? parseInt(last.dataset.messageId || '0', 10) : 0;
            if (!Number.isNaN(id) && id > lastId) lastId = id;
        }

        function connect() {
            socket = new WebSocket(wsUrl);

            socket.onopen = function () {
                wsConnected = true;
                updateLastIdFromDom();
                if (document.visibilityState === 'visible') sendReadAck(lastId);
                scrollToBottom();

                // Heartbeat keeps online counts accurate even if disconnect is missed.
                try {
                    if (window.__roomPingTimer) clearInterval(window.__roomPingTimer);
                    window.__roomPingTimer = setInterval(() => {
                        if (!wsConnected || !socket || socket.readyState !== WebSocket.OPEN) return;
                        try {
                            socket.send(JSON.stringify({ type: 'ping' }));
                        } catch {
                            // ignore
                        }
                    }, 20000);
                } catch {
                    // ignore
                }
            };

            socket.onmessage = function (event) {
                let payload;
                try {
                    payload = JSON.parse(event.data);
                } catch {
                    // Ignore unexpected non-JSON frames
                    return;
                }

                if (payload.type === 'chat_message' && payload.html) {
                    const emptyEl = document.getElementById('empty_state');
                    if (emptyEl) emptyEl.remove();
                    if (messagesEl && messagesEl.classList.contains('hidden')) {
                        messagesEl.classList.remove('hidden');
                    }
                    messagesEl.insertAdjacentHTML('beforeend', payload.html);
                    hydrateLocalTimes(messagesEl);
                    updateLastIdFromDom();
                    safeScrollToBottom();
                    if (document.visibilityState === 'visible') sendReadAck(lastId);
                    return;
                }

                if (payload.type === 'read_receipt') {
                    const readerId = parseInt(payload.reader_id || 0, 10) || 0;
                    const lastReadId = parseInt(payload.last_read_id || 0, 10) || 0;
                    if (readerId && readerId !== currentUserId) {
                        lastOtherReadId = Math.max(lastOtherReadId || 0, lastReadId || 0);
                        applyReadTicks(lastReadId);
                    }
                    return;
                }

                if (payload.type === 'typing') {
                    handleTypingEvent(payload);
                    return;
                }

                if (payload.type === 'message_update' && payload.message_id && payload.html) {
                    const el = document.getElementById(`msg-${payload.message_id}`);
                    if (el) {
                        el.outerHTML = payload.html;
                        hydrateLocalTimes(document);
                        applyReadTicks(lastOtherReadId);
                    }
                    return;
                }

                if (payload.type === 'message_delete' && payload.message_id) {
                    const el = document.getElementById(`msg-${payload.message_id}`);
                    if (el) el.remove();
                    return;
                }

                if (payload.type === 'reactions' && payload.message_id && payload.html) {
                    const el = document.getElementById(`reactions-${payload.message_id}`);
                    if (el) {
                        el.outerHTML = payload.html;
                    }
                    return;
                }

                if (payload.type === 'online_count' && typeof payload.online_count !== 'undefined') {
                    if (onlineCountEl) onlineCountEl.textContent = payload.online_count;
                }

                if (payload.type === 'call_invite') {
                    if (!window.__hasGlobalCallInvite) {
                        showIncomingCall(payload);
                    }
                }

                if (payload.type === 'call_control') {
                    if (payload.action === 'end' || payload.action === 'decline') {
                        endCallPopup(payload.action === 'decline' ? 'Call declined' : 'Call ended');
                    }
                }
            };

            socket.onclose = function () {
                wsConnected = false;
                try {
                    if (window.__roomPingTimer) clearInterval(window.__roomPingTimer);
                    window.__roomPingTimer = null;
                } catch {
                    // ignore
                }
                // Simple reconnect
                setTimeout(connect, 1000);
            };

            socket.onerror = function () {
                wsConnected = false;
            };
        }

        function isNearBottom() {
            try {
                const el = document.getElementById('chat_container');
                if (!el) return true;
                return (el.scrollHeight - el.scrollTop - el.clientHeight) < 120;
            } catch {
                return true;
            }
        }

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState !== 'visible') return;
            updateLastIdFromDom();
            if (isNearBottom()) sendReadAck(lastId);
        });

        window.addEventListener('focus', () => {
            updateLastIdFromDom();
            if (isNearBottom()) sendReadAck(lastId);
        });

        // Use query-by-id here to avoid referencing `chatContainer` before it's defined later in this file.
        const __chatContainerForRead = document.getElementById('chat_container');
        if (__chatContainerForRead) {
            __chatContainerForRead.addEventListener('scroll', () => {
                if (!isNearBottom()) return;
                updateLastIdFromDom();
                if (document.visibilityState === 'visible') sendReadAck(lastId);
            }, { passive: true });
        }

        // Ensure correct position on initial render
        document.addEventListener('DOMContentLoaded', function () {
            updateLastIdFromDom();
            hydrateLocalTimes(document);
            applyReadTicks(lastOtherReadId);
            safeScrollToBottom();
        });

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') maybeAckReadIfVisible();
        });
        window.addEventListener('focus', () => {
            maybeAckReadIfVisible();
        });

        (function initReadAckOnScroll() {
            const chatContainer = document.getElementById('chat_container');
            if (!chatContainer) return;
            let timer = null;
            chatContainer.addEventListener('scroll', () => {
                if (timer) window.clearTimeout(timer);
                timer = window.setTimeout(() => {
                    try {
                        const remaining = chatContainer.scrollHeight - (chatContainer.scrollTop + chatContainer.clientHeight);
                        if (remaining <= 80) maybeAckReadIfVisible();
                    } catch {
                        // ignore
                    }
                }, 120);
            }, { passive: true });
        })();

        // -------- Reactions (WhatsApp style click popup) --------
        function closeAllReactionPickers() {
            document.querySelectorAll('[data-reaction-picker]').forEach((el) => {
                el.classList.add('hidden');
            });
        }

        document.addEventListener('click', function (e) {
            const toggleBtn = e.target.closest('[data-reaction-toggle]');
            const emojiBtn = e.target.closest('[data-react-emoji]');

            if (toggleBtn) {
                e.preventDefault();
                e.stopPropagation();
                const messageId = toggleBtn.dataset.messageId;
                if (!messageId) return;
                const picker = document.querySelector(`[data-reaction-picker][data-message-id="${messageId}"]`);
                if (!picker) return;
                const willOpen = picker.classList.contains('hidden');
                closeAllReactionPickers();
                if (willOpen) picker.classList.remove('hidden');
                return;
            }

            if (emojiBtn) {
                e.preventDefault();
                e.stopPropagation();
                const messageId = emojiBtn.dataset.messageId;
                const emoji = emojiBtn.dataset.emoji;
                if (!messageId || !emoji) return;
                closeAllReactionPickers();
                const url = messageReactUrlTemplate.replace('/0/', `/${messageId}/`);
                const params = new URLSearchParams();
                params.set('emoji', emoji);
                fetch(url, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': (typeof getCookie === 'function' ? getCookie('csrftoken') : ''),
                    },
                    body: params,
                }).catch(() => {});
                return;
            }

            // Outside click closes pickers
            closeAllReactionPickers();
        });

        function closeAllMessageMenus(exceptMenu) {
            const menus = document.querySelectorAll('[data-message-menu]');
            menus.forEach((menu) => {
                if (exceptMenu && menu === exceptMenu) return;
                menu.classList.add('hidden');
                const toggle = menu.parentElement ? menu.parentElement.querySelector('[data-message-menu-toggle]') : null;
                if (toggle) toggle.setAttribute('aria-expanded', 'false');
            });
        }

        // Toggle actions menu on 3-dots click (not hover)
        document.addEventListener('click', function (e) {
            const toggle = e.target && e.target.closest ? e.target.closest('[data-message-menu-toggle]') : null;
            const insideMenu = e.target && e.target.closest ? e.target.closest('[data-message-menu]') : null;

            if (toggle) {
                e.preventDefault();
                e.stopPropagation();

                const wrapper = toggle.parentElement;
                const menu = wrapper ? wrapper.querySelector('[data-message-menu]') : null;
                if (!menu) return;

                const willOpen = menu.classList.contains('hidden');
                closeAllMessageMenus(willOpen ? menu : null);

                if (willOpen) {
                    menu.classList.remove('hidden');
                    toggle.setAttribute('aria-expanded', 'true');
                } else {
                    menu.classList.add('hidden');
                    toggle.setAttribute('aria-expanded', 'false');
                }
                return;
            }

            // Clicks inside menu should not close it
            if (insideMenu) return;

            // Click anywhere else closes menus
            closeAllMessageMenus();
        }, true);

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') closeAllMessageMenus();
        }, true);

        // -------- Message Edit/Delete (actions menu) --------
        document.addEventListener('click', async function (e) {
            const editBtn = e.target.closest('[data-edit-message]');
            const delBtn = e.target.closest('[data-delete-message]');

            if (!editBtn && !delBtn) return;
            e.preventDefault();
            e.stopPropagation();

            const messageId = (editBtn || delBtn).dataset.messageId;
            if (!messageId) return;

            // Close any open message menu after choosing an action
            closeAllMessageMenus();

            if (editBtn) {
                const body = editBtn.dataset.messageBody || '';
                startEditingMessage(messageId, body);
                return;
            }

            if (delBtn) {
                const url = messageDeleteUrlTemplate.replace('/0/', `/${messageId}/`);
                try {
                    await fetch(url, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': (typeof getCookie === 'function' ? getCookie('csrftoken') : ''),
                        },
                        body: new URLSearchParams(),
                    });
                } catch {
                    // ignore
                }
            }
        });

        function ensureIncomingContainer() {
            let c = document.getElementById('incoming-call-container');
            if (c) return c;
            c = document.createElement('div');
            c.id = 'incoming-call-container';
            c.className = 'fixed top-16 right-3 sm:top-20 sm:right-6 z-50 w-[min(24rem,calc(100vw-3rem))] space-y-3';
            document.body.appendChild(c);
            return c;
        }

        function showIncomingCall(payload) {
            const container = ensureIncomingContainer();
            const from = payload.from_username || 'Someone';
            const type = (payload.call_type || 'voice').toLowerCase() === 'video' ? 'video' : 'voice';

            playIncomingRing();

            const toast = document.createElement('div');
            toast.className = 'pointer-events-auto flex items-start gap-3 rounded-xl border border-gray-800 bg-gray-900/90 px-4 py-3 text-sm text-gray-100 shadow-lg shadow-black/20';
            toast.innerHTML = `
                <div class="mt-0.5 h-2.5 w-2.5 flex-none rounded-full bg-emerald-400"></div>
                <div class="flex-1">
                    <div class="font-semibold">Incoming ${type === 'video' ? 'video' : 'voice'} call</div>
                    <div class="text-gray-300 text-xs mt-0.5">from ${from}</div>
                    <div class="mt-3 flex gap-2">
                        <button type="button" data-accept class="text-xs bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-lg transition-colors">Accept</button>
                        <button type="button" data-decline class="text-xs bg-gray-800 hover:bg-gray-700 text-white px-3 py-1.5 rounded-lg transition-colors">Decline</button>
                    </div>
                </div>
                <button type="button" data-close class="-mr-1 -mt-1 inline-flex h-8 w-8 items-center justify-center rounded-lg text-gray-300 hover:text-white hover:bg-gray-800/60 transition" aria-label="Dismiss">
                    <span aria-hidden="true">√ó</span>
                </button>
            `;

            const removeToast = () => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 200);
                stopIncomingRing();
            };
            toast.querySelector('[data-close]')?.addEventListener('click', removeToast);
            toast.querySelector('[data-accept]')?.addEventListener('click', async () => {
                stopIncomingRing();
                window.__hasGlobalCallInvite = true;
                removeToast();
                await openCallPopup(type, 'callee');
            });
            toast.querySelector('[data-decline]')?.addEventListener('click', async () => {
                try {
                    const body = new URLSearchParams();
                    body.set('action', 'decline');
                    body.set('type', type);
                    await fetch(callEventUrl, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': (typeof getCookie === 'function' ? getCookie('csrftoken') : ''),
                        },
                        body,
                    });
                } catch {
                    // ignore
                }
                removeToast();
            });
            setTimeout(removeToast, 15000);

            container.appendChild(toast);
        }

        // --- Call popup (no separate page) ---
        const callPopupEl = document.getElementById('call_popup');
        const callPopupHeaderEl = document.getElementById('call_popup_header');
        const callPopupTitleEl = document.getElementById('call_popup_title');
        const callPopupSubtitleEl = document.getElementById('call_popup_subtitle');
        const callPopupStatusEl = document.getElementById('call_popup_status');
        const callPopupVideoEl = document.getElementById('call_popup_video');
        const callLocalEl = document.getElementById('call_local_player');
        const callRemoteEl = document.getElementById('call_remote_player');
        const callEndBtn = document.getElementById('call_popup_end');

        let callActive = false;
        let callTypeActive = null;
        let callRoleActive = null;
        let callClient = null;
        let localTracks = { audio: null, video: null };

        function setCallStatus(text) {
            if (callPopupStatusEl) callPopupStatusEl.textContent = text || '';
            if (callPopupSubtitleEl) callPopupSubtitleEl.textContent = text || '';
        }

        function showCallPopup() {
            if (!callPopupEl) return;
            callPopupEl.classList.remove('hidden');
        }

        function hideCallPopup() {
            if (!callPopupEl) return;
            callPopupEl.classList.add('hidden');
        }

        async function fetchAgoraToken() {
            const res = await fetch(tokenUrl, { credentials: 'same-origin' });

            // Handle rate limit cleanly.
            if (res.status === 429) {
                const retryAfter = Number(res.headers.get('Retry-After') || '10');
                throw new Error(`Rate limited. Try again in ${Number.isFinite(retryAfter) ? retryAfter : 10}s.`);
            }

            let data = null;
            try {
                data = await res.json();
            } catch {
                // Some servers return HTML on errors; include a short hint.
                const text = await res.text().catch(() => '');
                const hint = (text || '').slice(0, 140).replace(/\s+/g, ' ').trim();
                throw new Error(!res.ok ? `Token request failed (${res.status}). ${hint}` : 'Token response was not JSON.');
            }

            if (!res.ok || (data && data.error)) {
                throw new Error((data && data.error) ? String(data.error) : `Token request failed (${res.status}).`);
            }
            return data;
        }

        function getCsrf() {
            try { return (typeof getCookie === 'function' ? getCookie('csrftoken') : ''); } catch { return ''; }
        }

        async function announcePresence(action, uid, type) {
            try {
                const body = new URLSearchParams();
                body.set('action', action);
                body.set('type', type);
                body.set('uid', String(uid || 0));
                await fetch(presenceUrl, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCsrf(),
                    },
                    body,
                });
            } catch {
                // ignore
            }
        }

        async function postCallEvent(action, type) {
            try {
                const body = new URLSearchParams();
                body.set('action', action);
                body.set('type', type);
                await fetch(callEventUrl, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCsrf(),
                    },
                    body,
                });
            } catch {
                // ignore
            }
        }

        async function openCallPopup(type, role) {
            if (callActive) return;
            callActive = true;
            callTypeActive = (type || 'voice');
            callRoleActive = (role || 'caller');

            showCallPopup();
            if (callPopupTitleEl) callPopupTitleEl.textContent = callTypeActive === 'video' ? 'Video call' : 'Voice call';
            setCallStatus('Connecting‚Ä¶');

            if (callPopupVideoEl) {
                if (callTypeActive === 'video') {
                    callPopupVideoEl.classList.add('grid');
                    callPopupVideoEl.classList.remove('hidden');
                } else {
                    callPopupVideoEl.classList.remove('grid');
                    callPopupVideoEl.classList.add('hidden');
                }
            }

            try {
                const { token, uid, channel, app_id } = await fetchAgoraToken();
                if (!app_id) throw new Error('Agora is not configured (missing AGORA_APP_ID).');

                callClient = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });

                callClient.on('user-joined', (user) => {
                    if (callPopupSubtitleEl) {
                        callPopupSubtitleEl.textContent = otherUsername ? `${otherUsername} joined` : 'User joined';
                    }
                });

                callClient.on('user-published', async (user, mediaType) => {
                    await callClient.subscribe(user, mediaType);
                    if (mediaType === 'video' && callRemoteEl) {
                        try { user.videoTrack.play(callRemoteEl); } catch {}
                    }
                    if (mediaType === 'audio') {
                        try { user.audioTrack.play(); } catch {}
                    }
                    setCallStatus('In call');
                });

                callClient.on('user-left', () => {
                    setCallStatus('Waiting‚Ä¶');
                });

                await callClient.join(app_id, channel, token, uid);
                await announcePresence('join', uid, callTypeActive);

                if (callRoleActive === 'caller') {
                    await postCallEvent('start', callTypeActive);
                }

                localTracks.audio = await AgoraRTC.createMicrophoneAudioTrack({ AEC: true, AGC: true, ANS: true });
                if (callTypeActive === 'video') {
                    localTracks.video = await AgoraRTC.createCameraVideoTrack();
                    if (callLocalEl) {
                        try { localTracks.video.play(callLocalEl); } catch {}
                    }
                    await callClient.publish([localTracks.audio, localTracks.video]);
                } else {
                    await callClient.publish([localTracks.audio]);
                }

                setCallStatus('In call');
            } catch (e) {
                setCallStatus('Error: ' + (e && e.message ? e.message : String(e)));

                // Allow retry without refresh.
                try {
                    if (localTracks.video) {
                        try { localTracks.video.stop(); } catch {}
                        try { localTracks.video.close(); } catch {}
                    }
                    if (localTracks.audio) {
                        try { localTracks.audio.stop(); } catch {}
                        try { localTracks.audio.close(); } catch {}
                    }
                } catch {}
                try {
                    if (callClient) {
                        try { await callClient.leave(); } catch {}
                    }
                } catch {}

                callClient = null;
                localTracks = { audio: null, video: null };
                callActive = false;
                callTypeActive = null;
                callRoleActive = null;
            }
        }

        async function endCallPopup(reason) {
            if (!callActive) return;
            try {
                if (reason) setCallStatus(reason);
                // Broadcast end marker (only once is fine; server dedupes)
                if (callTypeActive) await postCallEvent('end', callTypeActive);
            } catch {}

            try {
                if (localTracks.video) {
                    try { localTracks.video.stop(); } catch {}
                    try { localTracks.video.close(); } catch {}
                }
                if (localTracks.audio) {
                    try { localTracks.audio.stop(); } catch {}
                    try { localTracks.audio.close(); } catch {}
                }
            } catch {}

            try {
                if (callClient) {
                    try { await callClient.leave(); } catch {}
                }
            } catch {}

            callClient = null;
            localTracks = { audio: null, video: null };
            callActive = false;
            callTypeActive = null;
            callRoleActive = null;
            hideCallPopup();
        }

        if (callEndBtn) {
            callEndBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                endCallPopup('Call ended');
            });
        }

        // Draggable popup
        (function () {
            if (!callPopupEl || !callPopupHeaderEl) return;
            let dragging = false;
            let offsetX = 0;
            let offsetY = 0;

            function stopDrag(e) {
                if (!dragging) return;
                dragging = false;
                try {
                    if (e && typeof e.pointerId !== 'undefined') {
                        callPopupHeaderEl.releasePointerCapture(e.pointerId);
                    }
                } catch {}
            }

            callPopupHeaderEl.addEventListener('pointerdown', (e) => {
                // Don't start dragging when clicking the End button (or any interactive element).
                const interactive = e.target && e.target.closest ? e.target.closest('button, a, input, select, textarea') : null;
                if (interactive) return;
                // Only left-click for mouse pointers.
                if (typeof e.button === 'number' && e.button !== 0) return;
                dragging = true;
                try { callPopupHeaderEl.setPointerCapture(e.pointerId); } catch {}
                const rect = callPopupEl.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
            });

            callPopupHeaderEl.addEventListener('pointermove', (e) => {
                if (!dragging) return;
                const left = Math.max(8, Math.min(window.innerWidth - callPopupEl.offsetWidth - 8, e.clientX - offsetX));
                const top = Math.max(8, Math.min(window.innerHeight - callPopupEl.offsetHeight - 8, e.clientY - offsetY));
                callPopupEl.style.left = `${left}px`;
                callPopupEl.style.top = `${top}px`;
                callPopupEl.style.right = 'auto';
                callPopupEl.style.bottom = 'auto';
            });

            callPopupHeaderEl.addEventListener('pointerup', (e) => {
                stopDrag(e);
            });

            callPopupHeaderEl.addEventListener('pointercancel', (e) => {
                stopDrag(e);
            });

            // Safety: if pointerup happens outside header, still stop dragging.
            window.addEventListener('pointerup', stopDrag, true);
            window.addEventListener('pointercancel', stopDrag, true);
        })();

        // When clicking call buttons, notify the other member first, then open popup.
        document.addEventListener('click', async function (e) {
            const a = e.target && e.target.closest ? e.target.closest('[data-call-btn]') : null;
            if (!a) return;
            e.preventDefault();

            const type = a.getAttribute('data-call-type') || 'voice';
            try {
                const body = new URLSearchParams();
                body.set('type', type);
                await fetch(inviteUrl, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': (typeof getCookie === 'function' ? getCookie('csrftoken') : ''),
                    },
                    body,
                });
            } catch {
                // ignore
            }
            await openCallPopup(type, 'caller');
        }, true);

        async function poll() {
            // Fallback: if websocket isn't connected, poll for new messages
            if (wsConnected) return;
            try {
                updateLastIdFromDom();
                const res = await fetch(`${pollUrl}?after=${lastId}`, { credentials: 'same-origin' });
                if (!res.ok) return;
                const data = await res.json();
                if (data && typeof data.online_count !== 'undefined') {
                    if (onlineCountEl) onlineCountEl.textContent = data.online_count;
                }
                if (data && data.messages_html) {
                    const emptyEl = document.getElementById('empty_state');
                    if (emptyEl) emptyEl.remove();
                    if (messagesEl && messagesEl.classList.contains('hidden')) {
                        messagesEl.classList.remove('hidden');
                    }
                    messagesEl.insertAdjacentHTML('beforeend', data.messages_html);
                    hydrateLocalTimes(messagesEl);
                    updateLastIdFromDom();
                    safeScrollToBottom();
                }
                if (data && typeof data.last_id !== 'undefined') {
                    const newLast = parseInt(String(data.last_id), 10);
                    if (!Number.isNaN(newLast) && newLast > lastId) lastId = newLast;
                }
            } catch {
                // ignore
            }
        }

        setInterval(poll, 1200);
        connect();

        function clearReply() {
            if (replyToIdInput) replyToIdInput.value = '';
            if (replyBar) replyBar.classList.add('hidden');
            if (replyBarAuthor) replyBarAuthor.textContent = '';
            if (replyBarPreview) replyBarPreview.textContent = '';
        }

        if (replyBarCancel) {
            replyBarCancel.addEventListener('click', function () {
                clearReply();
                if (input) input.focus();
            });
        }

        // Click "Reply" on a message bubble
        document.addEventListener('click', function (e) {
            const btn = e.target && e.target.closest ? e.target.closest('[data-reply-button]') : null;
            if (!btn) return;

            const msgId = btn.getAttribute('data-reply-to-id') || '';
            const author = btn.getAttribute('data-reply-author') || '';
            const preview = btn.getAttribute('data-reply-preview') || '';

            if (replyToIdInput) replyToIdInput.value = msgId;
            if (replyBarAuthor) replyBarAuthor.textContent = author;
            if (replyBarPreview) replyBarPreview.textContent = preview;
            if (replyBar) replyBar.classList.remove('hidden');
            if (input) input.focus();
        }, true);

        // Click replied-to snippet to jump to original
        document.addEventListener('click', function (e) {
            const jump = e.target && e.target.closest ? e.target.closest('[data-scroll-to]') : null;
            if (!jump) return;
            const targetId = jump.getAttribute('data-scroll-to');
            if (!targetId) return;
            const el = document.getElementById(targetId);
            if (!el) return;
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, true);
    })();
END LEGACY INLINE SCRIPT
{% endcomment %}

<script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
{% if chat_config %}
    {{ chat_config|json_script:"vixo-chat-config" }}
{% endif %}
<script src="{% static 'js/chat_loader.js' %}" defer></script>
{% endblock %}

{% block extra_body %}
{% comment %}
LEGACY INLINE SCRIPT REMOVED (moved to static/js/chat.js)
    (function initMobileSidebarToggle() {
        const sidebar = document.getElementById('chat_sidebar');
        const panel = document.getElementById('chat_sidebar_panel');
        const openBtn = document.getElementById('chat_sidebar_open');
        const closeBtn = document.getElementById('chat_sidebar_close');
        if (!sidebar || !panel || !openBtn || !closeBtn) return;

        const isMobile = () => !window.matchMedia('(min-width: 1024px)').matches;

        const overlayClasses = [
            'fixed', 'inset-0', 'z-50',
            'flex', 'items-start', 'justify-center',
            'bg-gray-900/60', 'p-4', 'pt-20'
        ];

        function closeSidebar() {
            if (!isMobile()) return;
            sidebar.classList.add('hidden');
            sidebar.classList.remove(...overlayClasses);
            document.body.classList.remove('overflow-hidden');
        }

        function openSidebar() {
            if (!isMobile()) return;
            sidebar.classList.remove('hidden');
            sidebar.classList.add(...overlayClasses);
            document.body.classList.add('overflow-hidden');
        }

        function sync() {
            if (!isMobile()) {
                sidebar.classList.remove('hidden');
                sidebar.classList.remove(...overlayClasses);
                document.body.classList.remove('overflow-hidden');
                return;
            }
            closeSidebar();
        }

        openBtn.addEventListener('click', openSidebar);
        closeBtn.addEventListener('click', closeSidebar);

        sidebar.addEventListener('click', (e) => {
            if (e.target === sidebar) {
                closeSidebar();
                return;
            }

            const link = e.target && e.target.closest ? e.target.closest('a') : null;
            if (!link) return;
            closeSidebar();
        });

        window.addEventListener('resize', sync);
        sync();
    })();

    (function initRoomCodeCopyAndHint() {
        const buttons = Array.from(document.querySelectorAll('[data-room-code-copy]'));
        const hint = document.getElementById('room_share_hint');

        function ensureToastContainer() {
            let c = document.getElementById('room-code-toast-container');
            if (c) return c;
            c = document.createElement('div');
            c.id = 'room-code-toast-container';
            c.className = 'fixed top-16 right-3 sm:top-20 sm:right-6 z-50 w-[min(24rem,calc(100vw-3rem))] space-y-3 pointer-events-none';
            document.body.appendChild(c);
            return c;
        }

        function showToast(text) {
            const container = ensureToastContainer();
            const toast = document.createElement('div');
            toast.className = 'pointer-events-auto flex items-start gap-3 rounded-xl border border-gray-800 bg-gray-900/90 px-4 py-3 text-sm text-gray-100 shadow-lg shadow-black/20 transition duration-200 ease-out';
            toast.innerHTML = `
                <div class="mt-0.5 h-2.5 w-2.5 flex-none rounded-full bg-emerald-400"></div>
                <div class="flex-1 leading-5">${(text || '').replace(/</g, '&lt;')}</div>
                <button type="button" class="-mr-1 -mt-1 inline-flex h-8 w-8 items-center justify-center rounded-lg text-gray-300 hover:text-white hover:bg-gray-800/60 transition" aria-label="Dismiss">
                    <span aria-hidden="true">√ó</span>
                </button>
            `;
            const closeBtn = toast.querySelector('button');
            const remove = () => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 200);
            };
            closeBtn?.addEventListener('click', remove);
            setTimeout(remove, 2500);
            container.appendChild(toast);
        }

        async function copyText(text) {
            const value = (text || '').trim();
            if (!value) return false;
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(value);
                    return true;
                }
            } catch {
                // fallback below
            }

            try {
                const ta = document.createElement('textarea');
                ta.value = value;
                ta.setAttribute('readonly', 'readonly');
                ta.style.position = 'fixed';
                ta.style.top = '-1000px';
                ta.style.left = '-1000px';
                document.body.appendChild(ta);
                ta.select();
                const ok = document.execCommand('copy');
                ta.remove();
                return ok;
            } catch {
                return false;
            }
        }

        buttons.forEach((btn) => {
            const code = btn.getAttribute('data-room-code-copy') || '';
            btn.addEventListener('click', async () => {
                const ok = await copyText(code);
                showToast(ok ? 'Room code copied.' : 'Could not copy. Please copy manually.');
            });
        });

        if (hint) {
            // animate in
            requestAnimationFrame(() => {
                hint.classList.remove('opacity-0', '-translate-y-2');
                hint.classList.add('opacity-100', 'translate-y-0');
            });
            // auto hide after 4s
            setTimeout(() => {
                hint.classList.add('opacity-0', '-translate-y-2');
                hint.classList.remove('opacity-100', 'translate-y-0');
                setTimeout(() => hint.remove(), 350);
            }, 4000);
        }
    })();
END LEGACY INLINE SCRIPT
{% endcomment %}
{% endblock %}