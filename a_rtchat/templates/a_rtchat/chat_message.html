{% load chat_extras %}

{% if message.body and message.body|slice:":6" == "[CALL]" %}
    <div data-message-id="{{ message.id }}" class="flex justify-center{% if extra_classes %} {{ extra_classes }}{% endif %}">
        <div class="max-w-[90%]">
            <div class="inline-flex items-center gap-2 rounded-full border border-gray-700 bg-gray-800/60 px-3 py-1.5 text-[11px] font-medium text-gray-200/80">
                <span>{{ message.body|cut:"[CALL] " }}</span>
                <span class="text-gray-500">•</span>
                <time class="text-gray-400/70" data-dt="{{ message.created|date:'c' }}"></time>
            </div>
        </div>
    </div>
{% else %}
<div id="msg-{{ message.id }}" data-message-id="{{ message.id }}" class="vixo-msg group relative w-full flex {% if message.author == user %}justify-end{% else %}justify-start{% endif %}{% if extra_classes %} {{ extra_classes }}{% endif %}">
    <div class="flex flex-col {% if message.author == user %}items-end{% else %}items-start{% endif %} max-w-[90%] sm:max-w-[75%] lg:max-w-[65%]">

        <div class="flex items-center gap-2 mb-1 px-1 w-full">
            {% if message.author != user %}
                <a href="{% url 'profile-user' message.author.username %}" class="inline-flex items-center gap-2 min-w-0">
                    <img src="{{ message.author.profile.avatar }}" class="w-6 h-6 rounded-full object-cover border border-white/10">
                    <span class="text-[14px] font-semibold text-gray-200 truncate">{{ message.author.profile.name|default:message.author.username }}</span>
                    {% if verified_user_ids and message.author_id in verified_user_ids %}
                        <span class="inline-flex h-4 w-4 items-center justify-center rounded-full bg-sky-500/20 text-sky-300 text-[10px] leading-none" title="Verified" aria-label="Verified">✓</span>
                    {% endif %}
                </a>
            {% else %}
                <span class="text-[14px] font-semibold text-gray-200/70 inline-flex items-center gap-2">
                    <span>You</span>
                    {% if verified_user_ids and user.id in verified_user_ids %}
                        <span class="inline-flex h-4 w-4 items-center justify-center rounded-full bg-sky-500/20 text-sky-300 text-[10px] leading-none" title="Verified" aria-label="Verified">✓</span>
                    {% endif %}
                </span>
            {% endif %}

            <time class="ml-auto text-[11px] text-gray-400/70" data-dt="{{ message.created|date:'c' }}"></time>

            <button type="button"
                class="text-[11px] text-gray-400 hover:text-indigo-300 transition-colors"
                data-reply-button
                data-reply-to-id="{{ message.id }}"
                data-reply-author="{{ message.author.profile.name|default:message.author.username|escape }}"
                data-reply-preview="{{ message.body|default:message.file_caption|default:message.filename|default:''|escape }}">
                Reply
            </button>

            {% if message.author == user or user.is_staff %}
                <div class="relative">
                    <button type="button"
                        class="opacity-80 hover:opacity-100 inline-flex h-8 w-8 items-center justify-center rounded-full text-gray-300 hover:text-white transition duration-150 ease-out hover:bg-gray-800/60 hover:scale-105 active:scale-95"
                        aria-label="Message actions"
                        aria-haspopup="menu"
                        aria-expanded="false"
                        data-message-menu-toggle>
                        ⋮
                    </button>

                    <div class="hidden absolute right-0 top-full mt-2 min-w-28 rounded-xl border border-gray-800 bg-gray-900/95 shadow-lg shadow-black/20 overflow-hidden z-50" data-message-menu role="menu">
                        {% if message.author == user and message.body and message.body|slice:":6" != "[CALL]" and not message.file %}
                            <button type="button"
                                data-edit-message
                                data-message-id="{{ message.id }}"
                                data-message-body="{{ message.body|default:''|escape }}"
                                class="w-full text-left px-3 py-2 text-xs text-gray-200 hover:bg-gray-800/60">
                                Edit
                            </button>
                        {% endif %}
                        <button type="button"
                            data-delete-message
                            data-message-id="{{ message.id }}"
                            class="w-full text-left px-3 py-2 text-xs text-gray-200 hover:bg-gray-800/60">
                            Delete
                        </button>

                        {% if user.is_staff and message.author != user and not message.author.is_superuser %}
                            <form method="post" action="{% url 'admin-user-toggle-block' message.author.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{% url 'chatroom' chat_group.group_name %}" />
                                <button type="submit"
                                    class="w-full text-left px-3 py-2 text-xs text-gray-200 hover:bg-gray-800/60">
                                    {% if message.author.profile.chat_blocked %}Unblock user{% else %}Block user{% endif %}
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>

        {% if message.auto_badges %}
            <div class="mb-1 px-1 w-full flex {% if message.author == user %}justify-end{% else %}justify-start{% endif %}">
                <div class="flex flex-wrap gap-1">
                    {% for b in message.auto_badges %}
                        <span class="inline-flex items-center gap-1 rounded-full border border-gray-800 bg-gray-900/50 px-2 py-0.5 text-[11px] text-gray-200/80">
                            <span aria-hidden="true">{{ b.icon }}</span>
                            <span>{{ b.label }}</span>
                        </span>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <div class="flex items-end gap-2">
            {% if message.author == user %}
                {% include 'a_rtchat/partials/reaction_picker.html' %}
            {% endif %}

            <div data-message-bubble class="px-4 py-3 rounded-2xl shadow-sm shadow-black/20 backdrop-blur-md 
                {% if message.author == user %}
                    bg-gradient-to-r from-purple-500 via-indigo-500 to-sky-500 text-white vixo-keep-white rounded-tr-none border border-white/10
                {% else %}
                    bg-white/5 text-gray-100 border border-white/10 rounded-tl-none
                {% endif %}">
                {% if message.reply_to %}
                    <button type="button" data-scroll-to="msg-{{ message.reply_to.id }}" class="block w-full text-left mb-2">
                        <div class="px-3 py-2 rounded-xl border-l-2 border-indigo-300/70 bg-white/5">
                            <div class="text-[10px] font-semibold text-gray-200/80">
                                Replying to {{ message.reply_to.author.profile.name|default:message.reply_to.author.username }}
                            </div>
                            <div class="text-[11px] text-gray-100/80 truncate">
                                {% if message.reply_to.body %}
                                    {{ message.reply_to.body|escape|highlight_mentions }}
                                {% elif message.reply_to.file %}
                                    {{ message.reply_to.filename }}
                                {% endif %}
                            </div>
                        </div>
                    </button>
                {% endif %}
                <div class="text-[15px] sm:text-[16px] leading-relaxed text-white/95{% if message.author == user %} vixo-keep-white{% endif %}">{% include 'a_rtchat/partials/message_content.html' %}</div>

                {% if message.link_url %}
                    <a href="{{ message.link_url }}" target="_blank" rel="noopener noreferrer"
                       class="mt-3 block rounded-xl border border-gray-800 bg-gray-950/30 overflow-hidden hover:bg-gray-800/30 transition-colors">
                        {% if message.link_image %}
                            <img src="{{ message.link_image }}" alt="" class="w-full h-36 object-cover" loading="lazy" />
                        {% endif %}
                        <div class="p-3">
                            {% if message.link_site_name %}
                                <div class="text-[10px] uppercase tracking-widest text-gray-400 mb-1">{{ message.link_site_name }}</div>
                            {% endif %}
                            {% if message.link_title %}
                                <div class="text-sm font-semibold text-gray-100 line-clamp-2">{{ message.link_title }}</div>
                            {% else %}
                                <div class="text-sm font-semibold text-gray-100 break-all">{{ message.link_url|slice:":80" }}</div>
                            {% endif %}
                            {% if message.link_description %}
                                <div class="text-xs text-gray-300 mt-1 line-clamp-3">{{ message.link_description }}</div>
                            {% endif %}
                        </div>
                    </a>
                {% endif %}
            </div>

            {% if message.author != user %}
                {% include 'a_rtchat/partials/reaction_picker.html' %}
            {% endif %}
        </div>

        {% include 'a_rtchat/partials/reactions_bar.html' %}
        
        <div class="mt-1 px-1 flex items-center gap-1">
            {% if message.author == user and chat_group.is_private %}
                {% with other_read=other_last_read_id|default:0 %}
                    <span class="text-[11px] text-gray-400/70" data-read-tick data-message-id="{{ message.id }}">
                        {% if other_read >= message.id %}✓✓{% else %}✓{% endif %}
                    </span>
                {% endwith %}
            {% endif %}
            {% if message.edited_at %}
                <span class="text-[11px] text-gray-400/60">• edited</span>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}