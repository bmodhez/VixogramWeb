{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vixogram - Chat. Call. Connect.</title>

    <link rel="icon" type="image/jpeg" href="{% static 'favicon.jpeg' %}">
    <link rel="shortcut icon" type="image/jpeg" href="{% static 'favicon.jpeg' %}">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/hyperscript.org@0.9.12"></script>

    <style>
        /* Smooth scrolling for chat window */
        #chat_container { scroll-behavior: smooth; }
    </style>
</head>
<body class="min-h-screen flex flex-col text-white antialiased bg-gradient-to-b from-gray-950 via-gray-900 to-gray-950">
    <nav class="sticky top-0 z-50 bg-gray-900/80 backdrop-blur border-b border-gray-800">
        <div class="w-full max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <a href="/" class="text-xl font-extrabold tracking-wide text-emerald-400 hover:text-emerald-300 transition-colors">
                Vixogram
            </a>

            {% if user.is_authenticated %}
                <div class="flex items-center gap-3">
                    <a href="{% url 'home' %}" class="text-sm text-gray-300 hover:text-white transition-colors px-3 py-2 rounded-lg hover:bg-gray-800">
                        Chat
                    </a>
                    <a href="{% url 'profile' %}" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors">
                        <img src="{{ user.profile.avatar }}" class="w-8 h-8 rounded-full object-cover border border-gray-700">
                        <span class="text-sm text-gray-200 font-semibold">{{ user.username }}</span>
                    </a>
                    <form method="post" action="{% url 'account_logout' %}">
                        {% csrf_token %}
                        <button type="submit" class="text-sm bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                            Logout
                        </button>
                    </form>
                </div>
            {% else %}
                <div class="flex items-center gap-3">
                    <a href="{% url 'account_login' %}" class="text-sm text-gray-200 hover:text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition-colors">
                        Login
                    </a>
                    <a href="{% url 'account_signup' %}" class="text-sm bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg transition-colors">
                        Sign up
                    </a>
                </div>
            {% endif %}
        </div>
    </nav>

    {% if messages %}
        <div id="toast-container" class="fixed top-20 right-6 z-50 w-[min(24rem,calc(100vw-3rem))] space-y-3 pointer-events-none">
            {% for message in messages %}
                {% with tags=message.tags %}
                    <div
                        class="toast pointer-events-auto flex items-start gap-3 rounded-xl border border-gray-800 bg-gray-900/90 px-4 py-3 text-sm text-gray-100 shadow-lg shadow-black/20 transition duration-200 ease-out"
                        data-duration="4000"
                        role="status"
                        aria-live="polite"
                    >
                        <div class="mt-0.5 h-2.5 w-2.5 flex-none rounded-full {% if 'error' in tags %}bg-red-500{% elif 'success' in tags %}bg-emerald-400{% else %}bg-gray-500{% endif %}"></div>
                        <div class="flex-1 leading-5">
                            {{ message }}
                        </div>
                        <button
                            type="button"
                            class="-mr-1 -mt-1 inline-flex h-8 w-8 items-center justify-center rounded-lg text-gray-300 hover:text-white hover:bg-gray-800/60 transition"
                            aria-label="Dismiss"
                            data-toast-close
                        >
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                {% endwith %}
            {% endfor %}
        </div>
    {% endif %}

    <main class="w-full max-w-7xl mx-auto px-6 py-6 flex-1">
        {% block content %}
        {% endblock %}
    </main>

    <div id="confirm-modal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="relative min-h-full flex items-center justify-center p-6">
            <div class="w-full max-w-md rounded-2xl border border-gray-800 bg-gray-900/95 shadow-2xl">
                <div class="px-5 py-4 border-b border-gray-800">
                    <div id="confirm-title" class="text-sm font-semibold text-white">Confirm</div>
                </div>
                <div class="px-5 py-4">
                    <div id="confirm-message" class="text-sm text-gray-300"></div>
                </div>
                <div class="px-5 py-4 border-t border-gray-800 flex items-center justify-end gap-2">
                    <button type="button" id="confirm-cancel" class="text-sm bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="button" id="confirm-ok" class="text-sm bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg transition-colors">
                        Yes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="w-full border-t border-gray-800 bg-gray-900/40 backdrop-blur">
        <div class="w-full max-w-7xl mx-auto px-6 py-5 text-center">
            <p class="text-sm text-gray-300 tracking-wide">
                Made in <span class="text-emerald-400">❤</span> with
                <span class="font-semibold text-gray-100">Bhavin</span>
                <span class="text-gray-500">•</span>
                <a
                    class="font-semibold text-emerald-400 hover:text-emerald-300 transition-colors"
                    href="https://www.instagram.com/bhavinmodhh/"
                    target="_blank"
                    rel="noopener noreferrer"
                >
                    Instagram
                </a>
            </p>
        </div>
    </footer>

    <script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    document.body.addEventListener('htmx:configRequest', (event) => {
        event.detail.headers['X-CSRFToken'] = getCookie('csrftoken');
    });

    function scrollToBottom() {
        const chatContainer = document.getElementById('chat_container');
        if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    }

    (function initToasts() {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const toasts = container.querySelectorAll('.toast');
        toasts.forEach((toast) => {
            let dismissed = false;
            const duration = Number(toast.getAttribute('data-duration') || '4000');
            const closeBtn = toast.querySelector('[data-toast-close]');

            const dismiss = () => {
                if (dismissed) return;
                dismissed = true;
                toast.classList.add('opacity-0', '-translate-y-1');
                toast.classList.add('transform');
                window.setTimeout(() => {
                    toast.remove();
                    if (container.childElementCount === 0) container.remove();
                }, 220);
            };

            if (closeBtn) closeBtn.addEventListener('click', dismiss);
            window.setTimeout(dismiss, Math.max(1000, duration));
        });
    })();

    (function initCustomConfirm() {
        const modal = document.getElementById('confirm-modal');
        const titleEl = document.getElementById('confirm-title');
        const msgEl = document.getElementById('confirm-message');
        const okBtn = document.getElementById('confirm-ok');
        const cancelBtn = document.getElementById('confirm-cancel');

        if (!modal || !okBtn || !cancelBtn || !titleEl || !msgEl) return;

        let pendingAction = null;

        const open = ({ title, message, onConfirm }) => {
            titleEl.textContent = title || 'Confirm';
            msgEl.textContent = message || 'Are you sure?';
            pendingAction = onConfirm || null;
            modal.classList.remove('hidden');
            modal.setAttribute('aria-hidden', 'false');
        };

        const close = () => {
            modal.classList.add('hidden');
            modal.setAttribute('aria-hidden', 'true');
            pendingAction = null;
        };

        okBtn.addEventListener('click', () => {
            const fn = pendingAction;
            close();
            if (typeof fn === 'function') fn();
        });
        cancelBtn.addEventListener('click', close);
        modal.addEventListener('click', (e) => {
            if (e.target === modal || e.target === modal.firstElementChild) close();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') close();
        });

        // Intercept submit/click based on data-confirm
        document.addEventListener('submit', (e) => {
            const form = e.target;
            if (!(form instanceof HTMLFormElement)) return;
            const message = form.getAttribute('data-confirm');
            if (!message) return;
            e.preventDefault();
            open({
                title: form.getAttribute('data-confirm-title') || 'Confirm',
                message,
                onConfirm: () => form.submit(),
            });
        }, true);

        document.addEventListener('click', (e) => {
            const btn = e.target && e.target.closest ? e.target.closest('[data-confirm]') : null;
            if (!btn) return;
            // If it is inside a form, submit handler will handle it.
            if (btn.closest('form')) return;
            const message = btn.getAttribute('data-confirm');
            if (!message) return;
            e.preventDefault();
            open({
                title: btn.getAttribute('data-confirm-title') || 'Confirm',
                message,
                onConfirm: () => {
                    if (btn.tagName === 'A' && btn.href) window.location.href = btn.href;
                    else btn.click();
                },
            });
        }, true);
    })();

    {% if user.is_authenticated %}
    (function initGlobalCallInvites() {
        // Lets chat pages know a global handler exists (avoid duplicate toasts)
        window.__hasGlobalCallInvite = true;

        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsUrl = `${wsScheme}://${window.location.host}/ws/notify/`;

        // -------- Ringtone (incoming) --------
        let audioCtx = null;
        let ringTimer = null;
        let audioUnlocked = false;
        const recentInvites = new Map();

        function unlockAudioOnce() {
            if (audioUnlocked) return;
            try {
                audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                g.gain.value = 0.00001;
                o.connect(g);
                g.connect(audioCtx.destination);
                o.start();
                o.stop(audioCtx.currentTime + 0.01);
                audioUnlocked = true;
            } catch {
                // ignore
            }
        }
        document.addEventListener('click', unlockAudioOnce, { once: true, capture: true });

        function stopIncomingRing() {
            if (ringTimer) {
                clearInterval(ringTimer);
                ringTimer = null;
            }
        }

        function playIncomingRing() {
            try {
                audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume().catch(() => {});
            } catch {
                return;
            }

            stopIncomingRing();

            const ringOnce = () => {
                try {
                    const ctx = audioCtx;
                    const now = ctx.currentTime;
                    const g = ctx.createGain();
                    g.gain.setValueAtTime(0.0001, now);
                    g.gain.exponentialRampToValueAtTime(0.15, now + 0.02);
                    g.gain.exponentialRampToValueAtTime(0.0001, now + 1.8);
                    g.connect(ctx.destination);

                    const o1 = ctx.createOscillator();
                    const o2 = ctx.createOscillator();
                    o1.type = 'sine';
                    o2.type = 'sine';
                    o1.frequency.setValueAtTime(480, now);
                    o2.frequency.setValueAtTime(620, now);
                    o1.connect(g);
                    o2.connect(g);
                    o1.start(now);
                    o2.start(now);
                    o1.stop(now + 1.9);
                    o2.stop(now + 1.9);
                } catch {
                    // ignore
                }
            };

            ringOnce();
            ringTimer = setInterval(ringOnce, 5000);
        }

        function ensureIncomingContainer() {
            let c = document.getElementById('incoming-call-container');
            if (c) return c;
            c = document.createElement('div');
            c.id = 'incoming-call-container';
            c.className = 'fixed top-24 right-6 z-50 w-[min(24rem,calc(100vw-3rem))] space-y-3';
            document.body.appendChild(c);
            return c;
        }

        async function declineInvite(callEventUrl, callType) {
            if (!callEventUrl) return;
            try {
                const body = new URLSearchParams();
                body.set('action', 'decline');
                body.set('type', callType || 'voice');
                await fetch(callEventUrl, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body,
                });
            } catch {
                // ignore
            }
        }

        function showIncomingCall(payload) {
            const from = payload.from_username || 'Someone';
            const type = (payload.call_type || 'voice').toLowerCase() === 'video' ? 'video' : 'voice';
            const room = payload.chatroom_name || '';
            const key = `${room}:${type}:${from}`;
            const now = Date.now();
            const last = recentInvites.get(key) || 0;
            if (now - last < 1200) return;
            recentInvites.set(key, now);

            const callUrl = payload.call_url || '';
            const callEventUrl = payload.call_event_url || '';
            if (!callUrl) return;

            playIncomingRing();

            const container = ensureIncomingContainer();
            const toast = document.createElement('div');
            toast.className = 'pointer-events-auto flex items-start gap-3 rounded-xl border border-gray-800 bg-gray-900/90 px-4 py-3 text-sm text-gray-100 shadow-lg shadow-black/20';
            toast.innerHTML = `
                <div class="mt-0.5 h-2.5 w-2.5 flex-none rounded-full bg-emerald-400"></div>
                <div class="flex-1">
                    <div class="font-semibold">Incoming ${type === 'video' ? 'video' : 'voice'} call</div>
                    <div class="text-gray-300 text-xs mt-0.5">from ${from}${room ? ` • room ${room}` : ''}</div>
                    <div class="mt-3 flex gap-2">
                        <a href="${callUrl}" class="text-xs bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-lg transition-colors">Accept</a>
                        <button type="button" data-decline class="text-xs bg-gray-800 hover:bg-gray-700 text-white px-3 py-1.5 rounded-lg transition-colors">Decline</button>
                    </div>
                </div>
                <button type="button" data-close class="-mr-1 -mt-1 inline-flex h-8 w-8 items-center justify-center rounded-lg text-gray-300 hover:text-white hover:bg-gray-800/60 transition" aria-label="Dismiss">
                    <span aria-hidden="true">×</span>
                </button>
            `;

            const removeToast = () => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 200);
                stopIncomingRing();
            };

            toast.querySelector('[data-close]')?.addEventListener('click', removeToast);
            toast.querySelector('[data-decline]')?.addEventListener('click', async () => {
                await declineInvite(callEventUrl, type);
                removeToast();
            });
            const accept = toast.querySelector('a');
            if (accept) accept.addEventListener('click', stopIncomingRing);

            setTimeout(removeToast, 15000);
            container.appendChild(toast);
        }

        function connect() {
            let socket;
            try {
                socket = new WebSocket(wsUrl);
            } catch {
                return;
            }

            socket.onmessage = function (event) {
                let payload;
                try { payload = JSON.parse(event.data); } catch { return; }
                if (payload.type === 'call_invite') showIncomingCall(payload);
            };
            socket.onclose = function () {
                setTimeout(connect, 1200);
            };
        }

        connect();
    })();
    {% endif %}
</script>

{% block extra_body %}{% endblock %}
</body>
</html>