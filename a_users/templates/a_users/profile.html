{% extends 'base.html' %}
{% load static %}
{% load user_filters %}

{% block body_class %} vixo-profile-page{% endblock %}

{% block content %}
<wrapper class="block max-w-md mx-auto my-10 px-6">
    <div class="relative rounded-2xl shadow-2xl border border-white/10 overflow-hidden">
        <!-- Full-card background -->
        <div class="absolute inset-0">
            {% if profile.cover_url %}
                <img src="{{ profile.cover_url }}" alt="Profile background" class="absolute inset-0 w-full h-full object-cover" />
            {% else %}
                <div class="absolute inset-0 bg-gradient-to-br from-purple-600/55 via-indigo-600/35 to-sky-600/55"></div>
            {% endif %}
            <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-black/45 to-black/75"></div>
            <div class="absolute inset-0 backdrop-blur-[2px]"></div>
        </div>

        <!-- Foreground -->
        <div class="relative bg-gray-900/40">
            <div class="flex justify-end p-3">
                <a href="{% url 'home' %}" class="bg-gray-900/60 hover:bg-gray-900/80 text-white rounded-lg px-4 py-2 transition-colors text-sm border border-white/10">
                    Back
                </a>
            </div>

            <div class="px-8 pb-8 pt-2">
                <div class="flex justify-center">
                    <img class="relative z-10 w-28 h-28 rounded-full object-cover ring-4 ring-black/40 border border-white/20"
                         src="{{ profile.avatar }}" alt="{{ profile.user.username }}">
                </div>

                <div class="text-center mt-4">

            <h1 class="text-2xl font-extrabold text-white inline-flex items-center justify-center gap-2">
                <span>{{ profile.name }}</span>
                {% if is_verified_badge %}
                    <span
                        class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-sky-500/20 text-sky-300 text-[11px] leading-none"
                        title="Verified"
                        aria-label="Verified"
                    >
                        âœ“
                    </span>
                {% endif %}
            </h1>
            <p class="text-gray-400">
                <span class="{% if profile_user and profile_user.profile and profile_user.profile.is_founder_club %}founder{% endif %}">
                    {% if profile_user and profile_user.profile and profile_user.profile.is_founder_club %}ðŸ‘‘{% endif %}
                    @{{ profile.user.username }}
                </span>
            </p>

            {% if profile_user and profile_user.profile and profile_user.profile.is_founder_club %}
                <div class="mt-2">
                    <span class="inline-flex items-center gap-2 rounded-full border border-yellow-500/30 bg-yellow-500/10 px-3 py-1 text-[11px] font-extrabold text-yellow-200">
                        <span aria-hidden="true">ðŸ‘‘</span>
                        <span>Founder Club</span>
                    </span>
                </div>
            {% endif %}

            {% if show_presence %}
                <div class="mt-2 flex items-center justify-center gap-2 text-xs text-gray-300" aria-label="Online status">
                    <span id="presence_dot" class="inline-block h-2.5 w-2.5 rounded-full {% if presence_online %}bg-emerald-400{% else %}bg-gray-500{% endif %}"></span>
                    <span id="presence_text">{% if presence_online %}Online{% else %}Offline{% endif %}</span>
                </div>
            {% endif %}

            {% if profile_user and profile_user.date_joined %}
                <p class="mt-1 text-xs text-gray-500">Joined {{ profile_user.date_joined|date:"M d, Y" }}</p>
            {% endif %}

            <div class="mt-4 px-4 text-gray-200 text-sm leading-relaxed">
                {% if profile.info %}
                    {{ profile.info|sanitize_bio }}
                {% else %}
                    <span class="text-gray-300">No bio added yet.</span>
                {% endif %}
            </div>

            <div class="mt-4 flex items-center justify-center gap-6">
                {% if show_follow_lists %}
                    <button
                        type="button"
                        class="text-center hover:opacity-90 transition-opacity"
                        data-follow-modal="followers"
                        data-url="{% url 'profile-followers' profile_user.username %}"
                    >
                        <div id="followers_count_value" class="text-lg font-extrabold text-white">{{ followers_count|default:0 }}</div>
                        <div class="text-xs text-gray-400">Followers</div>
                    </button>
                    <button
                        type="button"
                        class="text-center hover:opacity-90 transition-opacity"
                        data-follow-modal="following"
                        data-url="{% url 'profile-following' profile_user.username %}"
                    >
                        <div id="following_count_value" class="text-lg font-extrabold text-white">{{ following_count|default:0 }}</div>
                        <div class="text-xs text-gray-400">Following</div>
                    </button>
                {% else %}
                    <div class="text-center">
                        <div id="followers_count_value" class="text-lg font-extrabold text-white">{{ followers_count|default:0 }}</div>
                        <div class="text-xs text-gray-400">Followers</div>
                    </div>
                    <div class="text-center">
                        <div id="following_count_value" class="text-lg font-extrabold text-white">{{ following_count|default:0 }}</div>
                        <div class="text-xs text-gray-400">Following</div>
                    </div>
                {% endif %}
            </div>

            {% if not show_follow_lists and follow_lists_locked_reason %}
                {% if is_private and not is_owner %}
                    <div class="mt-6 text-xs text-gray-400">
                        <span class="text-gray-300 font-semibold" aria-hidden="true">âŠ˜</span>
                        <span class="ml-2">This acc is private. You cannot view following/followers unless the user makes account public.</span>
                    </div>
                {% else %}
                    <div class="mt-6 text-sm text-gray-300 bg-gray-900/40 rounded-xl p-4 border border-gray-700">
                        <div class="text-gray-200 font-semibold">Followers & Following</div>
                        <div class="text-xs text-gray-400 mt-1">{{ follow_lists_locked_reason }}</div>
                        {% if user.is_authenticated %}
                            <div class="mt-3">
                                <a href="{% url 'account_email' %}" class="bg-gray-700 hover:bg-gray-600 text-white rounded-lg px-4 py-2 transition-colors inline-block text-xs">Verify email</a>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            {% endif %}

            {% if user.is_authenticated and profile_user and user != profile_user %}
                <div class="mt-5 space-y-2">
                      <form method="post" action="{% url 'follow-toggle' profile_user.username %}"
                          data-loading-text="Loadingâ€¦"
                          {% if is_following %}data-confirm="Are you sure you want to unfollow @{{ profile_user.username }}?" data-confirm-title="Unfollow"{% endif %}>
                        {% csrf_token %}
                        <button type="submit"
                            class="w-full bg-gradient-to-r from-purple-500 via-indigo-500 to-sky-500 hover:from-purple-400 hover:via-indigo-400 hover:to-sky-400 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                            {% if is_following %}Unfollow{% else %}Follow{% endif %}
                        </button>
                    </form>
                          <a
                              href="{% url 'report-user' profile_user.username %}"
                              hx-get="{% url 'report-user' profile_user.username %}?modal=1"
                              hx-target="#global_modal_root"
                              hx-swap="innerHTML"
                              hx-push-url="false"
                              class="block w-full text-center bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                        Report
                    </a>
                </div>
            {% endif %}

            {% if user.is_authenticated and user == profile.user %}
                <div class="mt-8 flex w-full gap-3">
                    <a href="{% url 'profile-edit' %}"
                       class="flex-1 inline-flex items-center justify-center text-center whitespace-nowrap bg-gradient-to-r from-purple-500 via-indigo-500 to-sky-500 hover:from-purple-400 hover:via-indigo-400 hover:to-sky-400 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Edit profile
                    </a>
                    <a href="{% url 'profile-settings' %}"
                       class="flex-1 inline-flex items-center justify-center text-center whitespace-nowrap bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Settings
                    </a>
                </div>
            {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if show_follow_lists %}
    <div id="follow_modal" class="hidden fixed inset-0 z-50" aria-hidden="true">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="relative min-h-screen flex items-center justify-center px-4 py-8">
            <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 overflow-hidden">
                <div class="flex items-center justify-between px-5 py-4 border-b border-gray-700">
                    <div id="follow_modal_title" class="text-white font-bold">Follow list</div>
                    <button id="follow_modal_close" type="button" class="text-gray-300 hover:text-white px-2 py-1">âœ•</button>
                </div>

                <div id="follow_modal_body" class="p-5">
                    <div class="text-sm text-gray-400">Loading...</div>
                </div>
            </div>
        </div>
    </div>


    {% comment %}
    LEGACY INLINE SCRIPT REMOVED (moved to static/js/profile.js)
        (function initFollowListModal() {
            const modal = document.getElementById('follow_modal');
            const titleEl = document.getElementById('follow_modal_title');
            const closeBtn = document.getElementById('follow_modal_close');
            const bodyEl = document.getElementById('follow_modal_body');
            const followersEl = document.getElementById('followers_count_value');
            const followingEl = document.getElementById('following_count_value');
            if (!modal || !titleEl || !closeBtn || !bodyEl) return;

            const profileUsername = "{{ profile_user.username }}";
            const isOwner = {{ user.is_authenticated|yesno:"true,false" }} && ("{{ user.username }}" === profileUsername);

            const open = ({ kind, url }) => {
                modal.dataset.kind = kind;
                modal.dataset.baseUrl = url;
                modal.dataset.full = '0';
                modal.dataset.profileUsername = profileUsername;

                if (kind === 'following') titleEl.textContent = isOwner ? 'Your followings' : 'Following';
                else titleEl.textContent = isOwner ? 'Your followers' : 'Followers';

                modal.classList.remove('hidden');
                modal.setAttribute('aria-hidden', 'false');
                bodyEl.innerHTML = '<div class="text-sm text-gray-400">Loading...</div>';

                try {
                    if (window.htmx && typeof window.htmx.ajax === 'function') {
                        window.htmx.ajax('GET', url, { target: '#follow_modal_body', swap: 'innerHTML' });
                    }
                } catch {}
            };

            const close = () => {
                modal.classList.add('hidden');
                modal.setAttribute('aria-hidden', 'true');
            };

            closeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                close();
            });
            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target === modal.firstElementChild) close();
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) close();
            });

            document.addEventListener('click', (e) => {
                const btn = e.target && e.target.closest ? e.target.closest('[data-follow-modal]') : null;
                if (!btn) return;
                const kind = btn.getAttribute('data-follow-modal');
                const url = btn.getAttribute('data-url');
                if (!kind || !url) return;
                e.preventDefault();
                open({ kind, url });
            }, true);

            document.body.addEventListener('htmx:afterSwap', (e) => {
                try {
                    const target = e && e.detail && e.detail.target;
                    if (!target || target.id !== 'follow_modal_body') return;
                    const state = document.getElementById('follow_modal_state');
                    if (!state) return;
                    modal.dataset.kind = state.getAttribute('data-kind') || (modal.dataset.kind || '');
                    modal.dataset.full = state.getAttribute('data-full') || (modal.dataset.full || '0');
                } catch {}
            });

            document.body.addEventListener('followChanged', (e) => {
                try {
                    const detail = (e && e.detail) ? e.detail : {};
                    if (!detail || detail.profile_username !== profileUsername) return;

                    if (followersEl && typeof detail.followers_count === 'number') followersEl.textContent = String(detail.followers_count);
                    if (followingEl && typeof detail.following_count === 'number') followingEl.textContent = String(detail.following_count);

                    if (modal.classList.contains('hidden')) return;
                    if ((modal.dataset.kind || '') !== 'following') return;
                    const baseUrl = modal.dataset.baseUrl || '';
                    if (!baseUrl) return;

                    const isFull = (modal.dataset.full || '0') === '1';
                    const url = isFull ? (baseUrl + '?full=1') : baseUrl;
                    if (window.htmx && typeof window.htmx.ajax === 'function') {
                        window.htmx.ajax('GET', url, { target: '#follow_modal_body', swap: 'innerHTML' });
                    }
                } catch {}
            });
        })();
    END LEGACY INLINE SCRIPT
    {% endcomment %}
    {% endif %}

    {% if profile_config %}
        {{ profile_config|json_script:"vixo-profile-config" }}
    {% endif %}

    {% if user.is_authenticated %}
        <script src="{% static 'js/profile_loader.js' %}" defer></script>
    {% endif %}
</wrapper>
{% endblock %}